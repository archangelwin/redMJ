#include "Stdafx.h"
#include "Resource.h"
#include "DlgLogon.h"
#include "GlobalUnits.h"
#include "RoomViewItem.h"
#include "DlgControlBar.h"

#include "GamePlaza.h"
#include "GameFrame.h"
#include "BCMenu.h"
#include ".\roomviewitem.h"

#define		IDC_BT_BUTTON_ROOM1	8888			//功能按钮
#define		IDC_BT_BUTTON_ROOM2	8889			//功能按钮
#define		IDC_BT_BUTTON_ROOM3	8890			//功能按钮
#define		IDC_BT_BUTTON_ROOM4	8891			//功能按钮
#define		IDC_BT_BUTTON_ROOM5	8892			//功能按钮
#define		IDC_BT_BUTTON_ROOM6	8892			//功能按钮

#define		IDC_BT_BUTTON_ROOMEXIT 9999			//功能按钮
//////////////////////////////////////////////////////////////////////////


//按钮区域
#define	BUTTON_AREA_WIDTH			200									//按钮区域

//启动结果
#define	SR_CREATE_ERROR				0									//启动错误
#define	SR_CREATE_SUCCESS			1									//启动成功
#define	SR_ALREADY_EXIST			2									//已经存在

#define IDI_CHECK_GAMECLIENT		501									//检查游戏是否在运行,如果退了就显示大厅

//左框宽度
#define LEFT_FRAME_WIDTH 229

//聊天窗口到底边的距离
#define CHAT_BOTTOM_DISTANCE 0

//聊天窗口的高度
#define CHAT_HEIGHT 140


//////////////////////////////////////////////////////////////////////////
//菜单命令

//常规菜单
#define	IDM_UM_WISPER				WM_USER+100							//私聊菜单
#define	IDM_UM_COPY_NAME			WM_USER+101							//拷贝名字
#define	IDM_UM_SET_CHAT				WM_USER+102							//设置聊天
#define	IDM_UM_CANECL_CHAT			WM_USER+103							//取消聊天
#define	IDM_UM_LOOK_LOCATION		WM_USER+104							//查看位置
#define	IDM_UM_INVITE_PLAY			WM_USER+105							//邀请游戏
#define	IDM_UM_SEARCH_USER			WM_USER+106							//寻找用户
#define	IDM_UM_SET_FRIEND			WM_USER+107							//设为好友
#define	IDM_UM_SET_DETEST			WM_USER+108							//设为厌恶
#define IDM_UM_SHOW	                WM_USER+109                         //查看SHOW

//管理命令
#define IDM_UM_MANAGER_USER			WM_USER+150							//权限管理
#define IDM_UM_ISSUE_MESSAGE		WM_USER+151							//发布消息
#define IDM_IM_SYSTEM_OPTION		WM_USER+152							//系统设置
#define IDM_UM_SEND_WARNNING		WM_USER+153							//发送警告
#define IDM_UM_LOOK_USER_IP			WM_USER+154							//查看地址
#define IDM_UM_CUT_USER				WM_USER+155							//用户下线
#define IDM_UM_LIMIT_ACCOUN			WM_USER+156							//禁止帐户

//////////////////////////////////////////////////////////////////////////

BEGIN_MESSAGE_MAP(CRoomViewItem, CDialog)
	ON_WM_CTLCOLOR()
	ON_WM_SIZE()
	ON_WM_PAINT()
	ON_WM_COPYDATA()
	ON_WM_ERASEBKGND()
	ON_WM_SHOWWINDOW()
	ON_MESSAGE(WM_HIT_EXPMESSTION,	OnHitExpression)
	ON_BN_CLICKED(IDC_SEND_CHAT, OnBnClickedSendChat)
	ON_BN_CLICKED(IDC_COLOR_SET, OnBnClickedColorSet)
	ON_BN_CLICKED(IDC_EXPRESSION, OnBnClickedExpression)
	ON_BN_CLICKED(IDC_CLEAN_SCREEN,	OnBnClickedCleanScreen)
	ON_BN_CLICKED(IDB_BT_AUTO_JOIN,	OnBnClickedAutoSit)
	ON_BN_CLICKED(IMG_LISTCTRL_CMD_ID,OnBnUserList_Clicked)
	ON_BN_CLICKED(IDB_BT_SEARCH_USER,	OnBnClickedFindUser)

	ON_BN_CLICKED(IDC_BT_BUTTON_ROOMEXIT,	OnBnClickedRoomExit)
END_MESSAGE_MAP()

//////////////////////////////////////////////////////////////////////////

CRoomViewItem::CRoomViewItem() : CDialog(IDD_GAME_ROOM)
{
	//辅助变量
	m_wGameGenre=0;
	m_bRectify=false;
	m_bInitDialog=false;
	m_dwMenuUserID=0L;
	m_wReqTableID=INVALID_TABLE;
	m_wReqChairID=INVALID_CHAIR;
	m_wFindTableID=INVALID_TABLE;
	memset(&m_ListColumnInfo,0,sizeof(m_ListColumnInfo));

	m_pHtmlBrower1	= NULL;
	m_pHtmlBrower2	= NULL;

	//配置变量
	m_pGameOption=NULL;
	m_pServerOption=NULL;

	//聊天用户
	m_dwChatUserID=0L;
	m_szChatName[0]=0;

	//进程信息
	m_szShareName[0]=0;
	m_hWndChannel=NULL;
	m_hShareMemory=NULL;
	m_pShareMemory=NULL;
	memset(&g_GameProcessInfo,0,sizeof(g_GameProcessInfo));

	//设置变量
	m_pMeUserItem=NULL;
	m_pListServer=NULL;
	m_ServiceStatus=ServiceStatus_Null;
	memset(&m_OptionBuffer,0,sizeof(m_OptionBuffer));

	//左视图区
	HINSTANCE hInstance=AfxGetInstanceHandle();

	m_ImageTop.SetLoadInfo(USERLIST_TOP,hInstance);

	m_ImageInfo.SetLoadInfo(USERLIST_INFO,hInstance);
	m_ImageWeb.SetLoadInfo(USERLIST_WEB,hInstance);

	m_ImageML.SetLoadInfo(IDB_FRAME_ML,hInstance);
	m_ImageMR.SetLoadInfo(IDB_FRAME_MR,hInstance);

	m_ImageChatTL.SetLoadInfo(IDB_CHAT_TL,hInstance);
	m_ImageChatTM.SetLoadInfo(IDB_CHAT_TM,hInstance);
	m_ImageChatTR.SetLoadInfo(IDB_CHAT_TR,hInstance);

	m_QQShowL.SetLoadInfo(IDB_QQSHOW_L,hInstance);
	m_QQShowR.SetLoadInfo(IDB_QQSHOW_R,hInstance);
	m_QQShowB.SetLoadInfo(IDB_QQSHOW_B,hInstance);


	m_pFindUserDlg=NULL;
	m_pHtmlBrower = NULL;
	return;
}

CRoomViewItem::~CRoomViewItem()
{
	
	//清理内存
	if (m_pShareMemory!=NULL)
	{
		UnmapViewOfFile(m_pShareMemory);
		m_pShareMemory=NULL;
	}
	if (m_hShareMemory!=NULL)
	{
		CloseHandle(m_hShareMemory);
		m_hShareMemory=NULL;
	}

	for (INT_PTR i=0;i<m_ShortMessage.GetCount();i++) 
	{
		delete ((CShortMessage *)m_ShortMessage.GetAt(i));
		m_ShortMessage.SetAt(i,NULL);
	}
	SafeDelete(m_pFindUserDlg);

	return;
}

//接口查询
void * __cdecl CRoomViewItem::QueryInterface(const IID & Guid, DWORD dwQueryVer)
{
	QUERYINTERFACE(IViewItem,Guid,dwQueryVer);
	QUERYINTERFACE(IRoomViewItem,Guid,dwQueryVer);
	QUERYINTERFACE(ITableFrameSink,Guid,dwQueryVer);
	QUERYINTERFACE(IUserManagerSink,Guid,dwQueryVer);
	QUERYINTERFACE(IClientSocketSink,Guid,dwQueryVer);
	QUERYINTERFACE(IChannelMessageSink,Guid,dwQueryVer);
	QUERYINTERFACE_IUNKNOWNEX(IViewItem,Guid,dwQueryVer);
	return NULL;
}

//控件绑定
void CRoomViewItem::DoDataExchange(CDataExchange * pDX)
{
	__super::DoDataExchange(pDX);
	DDX_Control(pDX, IDC_PHRASE, m_btPhrase);
	DDX_Control(pDX, IDC_COLOR_SET, m_btColorSet);
	DDX_Control(pDX, IDC_SEND_CHAT, m_btSendChat);
	DDX_Control(pDX, IDC_EXPRESSION, m_btExpression);
	DDX_Control(pDX, IDC_CLEAN_SCREEN, m_btCleanScreen);
	DDX_Control(pDX, IDC_CHAT_INPUT, m_ChatInput);
	DDX_Control(pDX, IDC_CHAT_MESSAGE, m_ChatMessage);
	DDX_Control(pDX, IDC_CHAT_OBJECT, m_ChatObject);
}

//初始化函数
BOOL CRoomViewItem::OnInitDialog()
{
	__super::OnInitDialog();

	//设置控件

	if(m_UserListView.Create(NULL, WS_CHILD|SS_LEFT|SS_NOTIFY|WS_VISIBLE,CRect(0,0,0,0), this))
	{
		HINSTANCE hInstance=AfxGetInstanceHandle();
		m_UserListView.m_xTop.SetLoadInfo(USERLIST_T,hInstance);
		m_UserListView.m_xLeft.SetLoadInfo(USERLIST_L,hInstance);
		m_UserListView.m_xRight.SetLoadInfo(USERLIST_R,hInstance);
		m_UserListView.m_xBottom.SetLoadInfo(USERLIST_B,hInstance);
		m_UserListView.m_xScrollT.SetLoadInfo(USERLIST_S_T,hInstance);
		m_UserListView.m_xScrollM.SetLoadInfo(USERLIST_S_M,hInstance);
		m_UserListView.m_xScrollB.SetLoadInfo(USERLIST_S_B,hInstance);
		m_UserListView.m_xThumb.SetLoadInfo(USERLIST_S_THUMB,hInstance);

		m_UserListView.SetHeight(250);
		
		//for(int i=100001;i<=100021;i++)
		//	m_RoomList.AddButton(FindResource(NULL,"ROOMLIST_BTN",RT_BITMAP),IMG_LISTCTRL_CMD_ID,"诈金花房间1",20,5,0xffffff,i);
		m_UserListView.UpdateButton();
	}

	//m_UserListView.ShowWindow(SW_HIDE);

	m_pHtmlBrower = new CHtmlBrower();
	m_pHtmlBrower->Create(NULL,NULL,WS_VISIBLE|WS_CHILD,CRect(0,0,0,0),this,20,NULL);
	m_pHtmlBrower->EnableBrowser(true);

	tagGlobalUserData UserData=g_GlobalUnits.GetGolbalUserData();
	CString ShowUrl;
	ShowUrl.Format(UrlQQShow,UserData.szAccounts);
	g_GlobalUnits.AddSessionUrl(ShowUrl,ShowUrl);
	m_pHtmlBrower->Navigate(ShowUrl);

	m_ChatInput.LimitText(MAX_CHAT_LEN-1);
	m_ChatMessage.SetBackgroundColor(FALSE,RGB(212,246,255));

	//设置按钮
	HINSTANCE hInstance=AfxGetInstanceHandle();


	m_btAutoSit.Create(NULL,WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDB_BT_AUTO_JOIN);
	m_btAutoSit.LoadRgnImage(AfxGetInstanceHandle(),IDB_BT_AUTO_JOIN,0xff00ff);

	m_btFindUser.Create(NULL,WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDB_BT_SEARCH_USER);
	m_btFindUser.LoadRgnImage(AfxGetInstanceHandle(),IDB_BT_SEARCH_USER,0xff00ff);
	m_btFindUser.EnableWindow(false);

	m_btPhrase.SetButtonImage(IDB_BT_EXPESSION,hInstance,false);
	//m_btExpression.SetButtonImage(IDB_BT_EXPESSION,hInstance,false);
	m_btExpression.LoadRgnImage(AfxGetInstanceHandle(),IDB_BT_EXPESSION,0xff00ff);
	m_btColorSet.SetButtonImage(IDB_BT_COLOR_SET,hInstance,false);
	m_btCleanScreen.SetButtonImage(IDB_BT_CLEAN_SCREEN,hInstance,false);

	m_btSendChat.SetButtonImage(IDB_BT_SEND_CHAT,hInstance,false);

	//建立提示控件
	m_ToolTipCtrl.Create(this);
	m_ToolTipCtrl.Activate(TRUE);
	m_ToolTipCtrl.AddTool(GetDlgItem(IDC_EXPRESSION),TEXT("表情"));
	m_ToolTipCtrl.AddTool(GetDlgItem(IDC_COLOR_SET),TEXT("颜色"));
	m_ToolTipCtrl.AddTool(GetDlgItem(IDC_CLEAN_SCREEN),TEXT("清屏"));
	m_ToolTipCtrl.AddTool(GetDlgItem(IDC_SEND_CHAT),TEXT("发送"));

	m_btRoom1.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOM1);
	m_btRoom2.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOM2);
	m_btRoom3.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOM3);
	m_btRoom4.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOM4);
	m_btRoom5.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOM5);
	m_btRoom6.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOM6);
	
	m_pHtmlBrower1 = new CHtmlBrower;
	m_pHtmlBrower1->Create(NULL,NULL,WS_VISIBLE|WS_CHILD,CRect(12,460,157,509),this,20,NULL);
	m_pHtmlBrower1->EnableBrowser(true);
	m_pHtmlBrower1->Navigate("http://"ServerDomain"/Client/RoomNotice1.asp");

	m_pHtmlBrower2 = new CHtmlBrower;
	m_pHtmlBrower2->Create(NULL,NULL,WS_VISIBLE|WS_CHILD,CRect(472,447,778,494),this,20,NULL);
	m_pHtmlBrower2->EnableBrowser(true);
	m_pHtmlBrower2->Navigate("http://"ServerDomain"/Client/RoomNotice1.asp");


	m_btRoomExit.Create(TEXT(""),WS_CHILD|WS_VISIBLE,CRect(-999,0,0,0),this,IDC_BT_BUTTON_ROOMEXIT);

	m_btRoom1.SetButtonImage(USERLIST_ROOM1,hInstance,false);
	m_btRoom2.SetButtonImage(USERLIST_ROOM2,hInstance,false);
	m_btRoom3.SetButtonImage(USERLIST_ROOM3,hInstance,false);
	m_btRoom4.SetButtonImage(USERLIST_ROOM4,hInstance,false);
	m_btRoom5.SetButtonImage(USERLIST_ROOM5,hInstance,false);
	m_btRoom6.SetButtonImage(USERLIST_ROOM6,hInstance,false);

	m_btRoomExit.SetButtonImage(USERLIST_ROOMEXIT,hInstance,false);

	m_btRoom1.ShowWindow(SW_SHOW);
	m_btRoom2.EnableWindow(false);
	m_btRoom3.EnableWindow(false);
	m_btRoom4.EnableWindow(false);
	m_btRoom5.EnableWindow(false);
	m_btRoom6.EnableWindow(false);
	m_btRoomExit.ShowWindow(SW_SHOW);

	//聊天对象
	m_ChatObject.AddString(TEXT("所有人"));
	m_ChatObject.SetCurSel(0);

	//设置变量
	m_bInitDialog=true;

	return TRUE;
}

HBRUSH CRoomViewItem::OnCtlColor(CDC* pDC, CWnd* pWnd, UINT nCtlColor) 
{
	HBRUSH hbr = CDialog::OnCtlColor(pDC, pWnd, nCtlColor);
	
	if(pWnd->GetDlgCtrlID() == IDC_CHAT_INPUT)
	{
		m_brBkgnd.CreateSolidBrush(RGB(212,245,255));
		pDC->SetBkColor(RGB(212,245,255));	
		return (HBRUSH)m_brBkgnd;
	}
	if(pWnd->GetDlgCtrlID() == IDC_CHAT_OBJECT)
	{
		m_brBkgnd.CreateSolidBrush(RGB(212,246,255));
		pDC->SetBkColor(RGB(212,246,255));	
		return (HBRUSH)m_brBkgnd;
	}
	pDC->SetBkMode(TRANSPARENT);
	return hbr;
}


//消息过虑
BOOL CRoomViewItem::PreTranslateMessage(MSG * pMsg)
{
	if((pMsg->message==WM_KEYDOWN)
		&& (pMsg->wParam==VK_RETURN)
		&& (m_ServiceStatus==ServiceStatus_Serviceing))
	{
		OnBnClickedSendChat();
		return TRUE;
	}
	m_ToolTipCtrl.RelayEvent(pMsg);
	
	return __super::PreTranslateMessage(pMsg);
}

//菜单命令
BOOL CRoomViewItem::OnCommand(WPARAM wParam, LPARAM lParam)
{
	switch (LOWORD(wParam))
	{
	case IDM_UM_WISPER:			//私聊消息
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//发送私聊
			if (m_dwMenuUserID!=m_pMeUserItem->GetUserID()) SendUserWhisper(pIUserItem);
			
			return TRUE;
		}
	case IDM_UM_SHOW:			//用户SHOW
		{
		
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//查看SHOW
			if (m_dwMenuUserID!=m_pMeUserItem->GetUserID()) SendUserShow(pIUserItem);
			
			return TRUE;
		}
	case IDM_UM_COPY_NAME:		//拷贝名字
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//打开剪切板
			if (OpenClipboard()==FALSE) return TRUE;
			if (EmptyClipboard()==FALSE) { CloseClipboard(); return TRUE; }

			//复制数据
			HANDLE hData=GlobalAlloc(GMEM_MOVEABLE|GMEM_ZEROINIT,NAME_LEN);
			if (hData==NULL) 
			{
				CloseClipboard();
				return TRUE;
			}
			LPTSTR szMemName=(LPTSTR)GlobalLock(hData);
			lstrcpy(szMemName,pIUserItem->GetUserName());
			SetClipboardData(CF_TEXT,hData);
			GlobalUnlock(hData);
			CloseClipboard();

			//显示名字
			m_ChatInput.Paste();
			m_ChatInput.SetFocus();

			return TRUE;
		}
	case IDM_UM_SET_CHAT:		//设置聊天
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//设置对象
			if (m_dwMenuUserID!=m_pMeUserItem->GetUserID())
			{
				SetChatObject(pIUserItem);
				m_ChatInput.SetFocus();
			}

			return TRUE;
		}
	case IDM_UM_CANECL_CHAT:	//取消聊天
		{
			//设置对象
			SetChatObject(NULL);
			m_ChatInput.SetFocus();

			return TRUE;
		}
	case IDM_UM_LOOK_LOCATION:	//查看位置
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//定位位置
			tagUserData * pUserData=pIUserItem->GetUserData();
			if ((pUserData->wTableID!=INVALID_TABLE)&&(pUserData->wChairID!=INVALID_CHAIR))
			{
				m_TableFrame.EnsureVisibleTable(pUserData->wTableID);
				if (pUserData->cbUserStatus==US_LOOKON) m_TableFrame.FlashTable(pUserData->wTableID);
				else m_TableFrame.FlashChair(pUserData->wTableID,pUserData->wChairID);
			}

			return TRUE;
		}
	case IDM_UM_SEARCH_USER:	//寻找玩家
		{
			//点击按钮
			OnBnClickedFindUser();

			return TRUE;
		}
	case IDM_UM_INVITE_PLAY:	//邀请玩家
		{
			//状态判断
			if (m_ServiceStatus!=ServiceStatus_Serviceing) return TRUE;

			//过虑消息
			tagUserData * pUserData=m_pMeUserItem->GetUserData();
			if (pUserData->cbUserStatus==US_PLAY) return TRUE;
			if (pUserData->wTableID==INVALID_TABLE) return TRUE;

			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//发送命令
			CMD_GR_UserInviteReq UserInviteReq;
			UserInviteReq.wTableID=pUserData->wTableID;
			UserInviteReq.dwUserID=pIUserItem->GetUserID();
			m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_INVITE_REQ,&UserInviteReq,sizeof(UserInviteReq));

			//提示消息
			m_MessageProxyHelper->InsertSystemString(TEXT("成功发送用户邀请命令"),0);

			return TRUE;
		}
	case IDM_UM_SET_FRIEND:		//设为好友
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//变量定义
			tagCompanionItem CompanionItem;
			memset(&CompanionItem,0,sizeof(CompanionItem));
			tagUserData * pUserData=pIUserItem->GetUserData();

			//设置关系
			CompanionItem.wFaceID=pUserData->wFaceID;
			CompanionItem.dwUserID=pUserData->dwUserID;
			if (pUserData->cbCompanion==enCompanion_Friend)
			{
				pUserData->cbCompanion=enCompanion_UnKnow;
				CompanionItem.Companion=enCompanion_UnKnow;
			}
			else
			{
				pUserData->cbCompanion=enCompanion_Friend;
				CompanionItem.Companion=enCompanion_Friend;
			}
			lstrcpyn(CompanionItem.szAccounts,pUserData->szName,CountArray(CompanionItem.szAccounts));
				g_GlobalUnits.m_CompanionManager->InsertCompanionItem(CompanionItem);

			//改变通知
			OnUserItemUpdate(pIUserItem);

			return TRUE;
		}
	case IDM_UM_SET_DETEST:		//设为厌恶
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//变量定义
			tagCompanionItem CompanionItem;
			memset(&CompanionItem,0,sizeof(CompanionItem));
			tagUserData * pUserData=pIUserItem->GetUserData();

			//设置关系
			CompanionItem.wFaceID=pUserData->wFaceID;
			CompanionItem.dwUserID=pUserData->dwUserID;
			if (pUserData->cbCompanion==enCompanion_Detest)
			{
				pUserData->cbCompanion=enCompanion_UnKnow;
				CompanionItem.Companion=enCompanion_UnKnow;
			}
			else
			{
				pUserData->cbCompanion=enCompanion_Detest;
				CompanionItem.Companion=enCompanion_Detest;
			}
			lstrcpyn(CompanionItem.szAccounts,pUserData->szName,CountArray(CompanionItem.szAccounts));
			g_GlobalUnits.m_CompanionManager->InsertCompanionItem(CompanionItem);

			//改变通知
			OnUserItemUpdate(pIUserItem);

			//提示消息
			if (pUserData->cbCompanion==enCompanion_Detest)
			{
				TCHAR szMessage[256]=TEXT("");
				_snprintf(szMessage,CountArray(szMessage),TEXT("[ %s ] 设置为厌恶玩家，系统将屏蔽他的一切聊天消息"),pUserData->szName);
				m_MessageProxyHelper->InsertSystemString(szMessage,0);
			}

			return TRUE;
		}
	case IDM_UM_SEND_WARNNING:	//发送警告
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//权限判断
			tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
			if (CUserRight::CanSendWarning(pMeUserData->dwMasterRight)==false) return TRUE;

			//创建窗口
			if (m_ManagerSendWarning.m_hWnd==NULL) 
			{
				m_ManagerSendWarning.Create(IDD_SEND_WARNING,this);
				m_ManagerSendWarning.SetClientUserManager(GET_OBJECT_INTERFACE(m_ClientUserManager,IUnknownEx));
				m_ManagerSendWarning.SetClientSocket(GET_OBJECTPTR_INTERFACE(m_ClientSocket.GetInterface(),IUnknownEx));
			}

			//设置变量
			m_ManagerSendWarning.SetUserItem(pIUserItem);

			//显示窗口
			m_ManagerSendWarning.ShowWindow(SW_SHOW);
			m_ManagerSendWarning.BringWindowToTop();

			return TRUE;
		}
	case IDM_UM_LOOK_USER_IP:	//查看地址
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//权限判断
			tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
			if (CUserRight::CanSeeUserIP(pMeUserData->dwMasterRight)==false) return TRUE;

			//发送命令
			CMD_GR_LookUserIP LookUserIP;
			LookUserIP.dwTargetUserID=pIUserItem->GetUserID();
			m_ClientSocket->SendData(MDM_GR_MANAGER,SUB_GR_LOOK_USER_IP,&LookUserIP,sizeof(LookUserIP));

			return TRUE;
		}
	case IDM_UM_CUT_USER:		//踢出用户
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//权限判断
			tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
			if (CUserRight::CanCutUser(pMeUserData->dwMasterRight)==false) return TRUE;

			//发送命令
			CMD_GR_KillUser KillUser;
			KillUser.dwTargetUserID=pIUserItem->GetUserID();
			m_ClientSocket->SendData(MDM_GR_MANAGER,SUB_GR_KILL_USER,&KillUser,sizeof(KillUser));

			return TRUE;
		}
	case IDM_UM_LIMIT_ACCOUN:	//禁用帐户
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//权限判断
			tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
			if (CUserRight::CanForbidAccounts(pMeUserData->dwMasterRight)==false) return TRUE;

			//确认提示
			TCHAR szMessage[128]=TEXT("");
			_snprintf(szMessage,CountArray(szMessage),TEXT("确实要冻结 [ %s ] 的帐号吗？"),pIUserItem->GetUserName());
			if (ShowMessageBox(szMessage,MB_ICONQUESTION|MB_YESNO)!=IDYES) return TRUE;

			//用户判断
			if (pIUserItem->GetUserID()!=m_dwMenuUserID) 
			{
				_snprintf(szMessage,CountArray(szMessage),TEXT("用户 [ %s ] 已经离开了游戏房间，帐号冻结失败"),pIUserItem->GetUserName());
				m_MessageProxyHelper->InsertSystemString(szMessage,0);
			
				return TRUE;
			}

			//发送命令
			CMD_GR_LimitAccounts LimitAccounts;
			LimitAccounts.dwTargetUserID=pIUserItem->GetUserID();
			m_ClientSocket->SendData(MDM_GR_MANAGER,SUB_GR_LIMIT_ACCOUNS,&LimitAccounts,sizeof(LimitAccounts));

			return TRUE;
		}
	case IDM_UM_MANAGER_USER:	//权限管理
		{
			//寻找玩家
			if (m_dwMenuUserID==0L) return TRUE;
			IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(m_dwMenuUserID);
			if (pIUserItem==NULL) return TRUE;

			//创建窗口
			if (m_ManagerUserRight.m_hWnd==NULL) 
			{
				m_ManagerUserRight.Create(IDD_MANAGER_RIGHT,this);
				m_ManagerUserRight.SetMasterRight(m_pMeUserItem->GetUserData()->dwMasterRight);
				m_ManagerUserRight.SetClientUserManager(GET_OBJECT_INTERFACE(m_ClientUserManager,IUnknownEx));
				m_ManagerUserRight.SetClientSocket(GET_OBJECTPTR_INTERFACE(m_ClientSocket.GetInterface(),IUnknownEx));
			}

			//设置变量
			m_ManagerUserRight.SetUserItem(pIUserItem);

			//显示窗口
			m_ManagerUserRight.ShowWindow(SW_SHOW);
			m_ManagerUserRight.BringWindowToTop();

			return TRUE;
		}
	case IDM_UM_ISSUE_MESSAGE:	//发布消息
		{
			//权限判断
			tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
			if (CUserRight::CanIssueMessage(pMeUserData->dwMasterRight)==false) return TRUE;

			//创建窗口
			if (m_ManagerMessage.m_hWnd==NULL) 
			{
				m_ManagerMessage.Create(IDD_MANAGER_MESSAGE,this);
				m_ManagerMessage.SetClientSocket(GET_OBJECTPTR_INTERFACE(m_ClientSocket.GetInterface(),IUnknownEx));
			}

			//显示窗口
			m_ManagerMessage.ShowWindow(SW_SHOW);
			m_ManagerMessage.BringWindowToTop();

			return TRUE;
		}
	case IDM_IM_SYSTEM_OPTION:	//房间管理
		{
			//权限判断
			tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
			if (CUserRight::CanServerOption(pMeUserData->dwMasterRight)==false) return TRUE;

			//创建窗口
			if (m_ManagerServer.m_hWnd==NULL) 
			{
				m_ManagerServer.Create(IDD_MANAGER_SERVER,this);
				m_ManagerServer.SetClientSocket(GET_OBJECTPTR_INTERFACE(m_ClientSocket.GetInterface(),IUnknownEx));
			}

			//显示窗口
			m_ManagerServer.ShowWindow(SW_SHOW);
			m_ManagerServer.BringWindowToTop();

			return TRUE;
		}
	}

	return __super::OnCommand(wParam,lParam);
}

//绘画消息
void CRoomViewItem::OnPaint()
{
	CPaintDC dc(this);

	//绘画界面
	DrawLeftViewFrame(&dc);

	return;
}

//绘画背景
BOOL CRoomViewItem::OnEraseBkgnd(CDC * pDC)
{
	return TRUE;
}

//位置消息
void CRoomViewItem::OnSize(UINT nType, int cx, int cy)
{
	__super::OnSize(nType, cx, cy);

	//调整控件
	RectifyControl(cx,cy);

	return;
}

//显示消息
void CRoomViewItem::OnShowWindow(BOOL bShow, UINT nStatus)
{
	__super::OnShowWindow(bShow, nStatus);

	//设置标题
	if (bShow) UpdateTitleText();

	return;
}


//IPC 消息
BOOL CRoomViewItem::OnCopyData(CWnd *pWnd, COPYDATASTRUCT *pCopyDataStruct)
{
	if (m_IPCRecvCopyData.OnCopyData(pWnd->GetSafeHwnd(), pCopyDataStruct)==true) return TRUE;
	return __super::OnCopyData(pWnd, pCopyDataStruct);
}

//表情消息
LRESULT CRoomViewItem::OnHitExpression(WPARAM wParam, LPARAM lParam)
{
	CExpressionItem * pExpressionItem=m_Expression.GetExpressItem((WORD)wParam);
	if (pExpressionItem!=NULL)
	{
		CString strBuffer;
		m_ChatInput.GetWindowText(strBuffer);
		strBuffer+=pExpressionItem->m_szTrancelate;
		m_ChatInput.SetWindowText(strBuffer);
		m_ChatInput.SetFocus();
		m_ChatInput.SetSel(strBuffer.GetLength(),strBuffer.GetLength());
	}

	return 0;
}
//int Random(int b)
//{
//	srand(::GetTickCount());
//	int a = rand();
//	while( !(a >=1&&a<=b))
//	{
//		srand(::GetTickCount());
//		a = rand();
//	}
//	return a;
//}

int AverageRandom(int min,int max)
{
	srand( (unsigned)time( NULL ) );	
	int minInteger = (int)(min*10000);
	int maxInteger = (int)(max*10000);
	int randInteger = rand()*rand();
	int diffInteger = maxInteger - minInteger;
	int resultInteger = randInteger % diffInteger + minInteger;
	return resultInteger/10000;
}

//发送按钮
void CRoomViewItem::OnBnClickedSendChat()
{
	//聊天信息
	if(::GetTickCount() - m_dwLastChat<3000)
	{
		srand( (unsigned)time( NULL ) );		
		int a = AverageRandom(1,2);
		switch(a)
		{
		case 1:
			MessageBox("您的打字速度好快啊！不过……您的发言也过快了哦！");
			break;
		case 2:
			MessageBox("您的打字速度好快啊！不过……您的发言也过快了哦！");
			break;
		}
		return;
	}

	TCHAR szChatMessage[MAX_CHAT_LEN]=TEXT("");
	m_ChatInput.GetWindowText(szChatMessage,CountArray(szChatMessage));
	if (szChatMessage[0]!=0)
	{
		m_ChatInput.SetWindowText(TEXT(""));
		SendChatPacket(m_dwChatUserID,szChatMessage,g_GlobalOption.m_crChatTX);
		m_dwLastChat = ::GetTickCount();
	}

	//设置界面
	m_ChatInput.SetFocus();

	return;
}

//表情按钮
void CRoomViewItem::OnBnClickedExpression()
{
	//建立表情窗口
	if (m_Expression.GetSafeHwnd()==NULL) m_Expression.CreateExpression(this);

	//移动窗口
	CRect rcButton;
	CSize ExpressSize;
	m_Expression.GetFixSize(ExpressSize);
	m_btExpression.GetWindowRect(&rcButton);
	m_Expression.MoveWindow(rcButton.right-ExpressSize.cx,rcButton.top-ExpressSize.cy,ExpressSize.cx,ExpressSize.cy);
	m_Expression.ShowWindow(SW_SHOW);
	m_Expression.SetFocus();

	return;
}

//颜色按钮
void CRoomViewItem::OnBnClickedColorSet()
{
	//设置颜色
	CColorDialog ColorDialog(g_GlobalOption.m_crChatTX,CC_FULLOPEN);
	if (ColorDialog.DoModal()==IDOK) g_GlobalOption.m_crChatTX = ColorDialog.GetColor();

	//设置界面
	m_ChatInput.SetFocus();

	return;
}

//清屏按钮
void CRoomViewItem::OnBnClickedCleanScreen()
{
	m_MessageProxyHelper->CleanScreen();
	return;
}

//类型信息
tagGameKind * __cdecl CRoomViewItem::GetKindInfo()
{
	if (m_pListServer!=NULL)
	{
		CListKind * pListKind=m_pListServer->GetListKind();
		ASSERT(pListKind!=NULL);
		if (pListKind!=NULL)
		{
			return pListKind->GetItemInfo();
		}
	}
	return NULL;
}

//加入按钮
void CRoomViewItem::OnBnClickedAutoSit()
{
	//bluker:如果由服务器派桌，就直发PerformLookonAction(INVALID_TABLE, WORD INVALID_CHAIR);
	if(IsServerAllocTable())
	{
		PerformLookonAction(INVALID_TABLE, WORD INVALID_CHAIR);
		return;
	}
	//判断状态
	if (m_ServiceStatus!=ServiceStatus_Serviceing) return;

	if ((m_wReqTableID!=INVALID_TABLE)||(m_wReqChairID!=INVALID_CHAIR))
	{
		TCHAR szMessage[]=TEXT("上次请求还没有收到服务器回应，请稍候！");
		ShowMessageBox(szMessage,MB_ICONINFORMATION);
		return;
	}

	//判断状态
	tagUserData * pUserData=m_pMeUserItem->GetUserData();
	if (pUserData->cbUserStatus==US_PLAY)
	{
		TCHAR szMessage[]=TEXT("你正在游戏中，不能换位置，请先结束游戏！");
		ShowMessageBox(szMessage,MB_ICONINFORMATION);
		return;
	}

	//先搜索桌子不全空的
	tagFindTable FindInfo;
	FindInfo.bAllNull=false;
	FindInfo.bFilterPass=true;
	FindInfo.bNotFull=true;
	FindInfo.bOneNull=true;
	FindInfo.bTwoNull=(m_TableFrame.GetChairCount()!=2);
	FindInfo.wBeginTableID=m_wFindTableID+1;
	FindInfo.wResultTableID=INVALID_TABLE;
	FindInfo.wResultChairID=INVALID_CHAIR;
	bool bSuccess=FindGameTable(FindInfo);
	m_wFindTableID=FindInfo.wResultTableID;

	//搜索全部游戏桌
	if (bSuccess==false)
	{
		FindInfo.bAllNull=true;
		FindInfo.bFilterPass=true;
		FindInfo.bNotFull=true;
		FindInfo.bOneNull=true;
		FindInfo.bTwoNull=true;
		FindInfo.wBeginTableID=m_wFindTableID+1;
		FindInfo.wResultTableID=INVALID_TABLE;
		FindInfo.wResultChairID=INVALID_CHAIR;
		bSuccess=FindGameTable(FindInfo);
		m_wFindTableID=FindInfo.wResultTableID;
	}

	//结果判断
	if (bSuccess==true)
	{
		//效验数据
		ASSERT(FindInfo.wResultTableID!=INVALID_TABLE);
		ASSERT(FindInfo.wResultChairID!=INVALID_CHAIR);

		//设置数据
		WORD wChairID=FindInfo.wResultChairID;
		m_TableFrame.EnsureVisibleTable(m_wFindTableID);
		m_TableFrame.FlashChair(m_wFindTableID,wChairID);

		//自动坐下
		PerformSitDownAction(m_wFindTableID,wChairID);
	}
	else
	{
		TCHAR szMessage[]=TEXT("找不到符号条件的游戏桌！");
		ShowMessageBox(szMessage,MB_ICONINFORMATION);
	}

	return;
}

//查找按钮
void CRoomViewItem::OnBnClickedFindUser()
{
	if (m_pFindUserDlg==NULL)
	{
		m_pFindUserDlg=new CFindUserDlg(this,0);
		m_pFindUserDlg->m_UserList.m_wGameGenre=m_wGameGenre;
		m_pFindUserDlg->m_UserList.m_wKindID=m_pListServer->GetItemInfo()->wKindID;
	}
	if (m_pFindUserDlg->GetSafeHwnd()==NULL)
	{
		m_pFindUserDlg->Create(IDD_FIND_USER,this);
		m_pFindUserDlg->m_UserList.SetColumnDescribe(m_ListColumnInfo.ColumnItem,m_ListColumnInfo.wColumnCount);
	}
	m_pFindUserDlg->ShowWindow(SW_SHOW);
	return;
}

//查找按钮
void CRoomViewItem::OnBnClickedRoomExit()
{
	g_pControlBar->CloseRoomViewItem(this);
	return;
}

//房间信息
tagGameServer * __cdecl CRoomViewItem::GetServerInfo()
{
	if (m_pListServer==NULL) return NULL;
	return m_pListServer->GetItemInfo();
}

//关闭通知
void __cdecl CRoomViewItem::CloseRoomViewItem()
{
	//关闭连接
	if (m_ClientSocket.GetInterface()!=NULL) m_ClientSocket->CloseSocket(false);

	//关闭游戏
	CloseGameClient();

	//清理内存
	if (m_pShareMemory!=NULL)
	{
		UnmapViewOfFile(m_pShareMemory);
		m_pShareMemory=NULL;
	}
	if (m_hShareMemory!=NULL)
	{
		CloseHandle(m_hShareMemory);
		m_hShareMemory=NULL;
	}

	//关闭窗口
	DestroyWindow();

	return;
}

//按钮消息
bool CRoomViewItem::OnSplitterButton(CSkinSplitter * pSkinSplitter, CSkinButton * pSplitterButton)
{
	return true;
}

//拆分条消息
bool CRoomViewItem::OnSplitterEvent(CSkinSplitter * pSkinSplitter, UINT uSplitID, int nXPos, int nYPos)
{
	CRect rcClient;
	GetClientRect(&rcClient);
	RectifyControl(rcClient.Width(),rcClient.Height());

	return true;
}

//初始化
bool CRoomViewItem::InitRoomViewItem(CListServer * pListServer)
{
	//设置变量
	ASSERT(pListServer!=NULL);
	m_pListServer=pListServer;

	//信息代理
	if (m_MessageProxyHelper.CreateInstance()==false) return false;
	if (m_MessageProxyHelper->SetRichEditHwnd(&m_ChatMessage)==false) return false;

	//设置组件
	IUnknownEx * pIUnknownEx=GET_MYSELF_INTERFACE(IUnknownEx);
	if (m_ClientSocket.CreateInstance()==false) return false;
	if (m_ClientSocket->SetSocketSink(pIUnknownEx)==false) return false;
	if (m_ClientUserManager.SetUserManagerSink(pIUnknownEx)==false) return false;
	if (m_IPCRecvCopyData.SetChannelMessageSink(pIUnknownEx)==false) return false;

	//设置颜色
	tagMessageOption MessageOption;
	memset(&MessageOption,0,sizeof(MessageOption));
	MessageOption.crName=g_GlobalOption.m_crMsgName;
	MessageOption.crSystemHead=g_GlobalOption.m_crMsgSysHead;
	MessageOption.crSystemString=g_GlobalOption.m_crMsgSysString;
	m_MessageProxyHelper->SetMessageOption(MessageOption);

	//建立共享内存
	tagGameServer * pGameServer=m_pListServer->GetItemInfo();
	_snprintf(m_szShareName,sizeof(m_szShareName),TEXT("0x8%ld%ld%ld%ld"),pGameServer->dwServerAddr,pGameServer->wServerPort,time(NULL),rand()%100);
	m_hShareMemory=(HANDLE)CreateFileMapping((HANDLE)0xFFFFFFFFFFFF,NULL,PAGE_READWRITE,0,sizeof(tagShareMemory),m_szShareName);
	if ((m_hShareMemory==NULL)||(GetLastError()==ERROR_ALREADY_EXISTS)) return false;
	m_pShareMemory=(tagShareMemory *)MapViewOfFile(m_hShareMemory,FILE_MAP_ALL_ACCESS,0,0,0);

	//设置共享内存
	memset(m_pShareMemory,0,sizeof(tagShareMemory));
	m_pShareMemory->wDataSize=sizeof(tagShareMemory);
	m_pShareMemory->hWndGameServer=m_hWnd;
	m_pShareMemory->hWndGamePlaza=AfxGetMainWnd()->m_hWnd;

	//配置信息
	m_pServerOption=g_GlobalOption.GetServerOption(pListServer);
	m_pGameOption=g_GlobalOption.GetGameOption(pListServer->GetListKind());
	ASSERT(m_pGameOption!=NULL);
	ASSERT(m_pServerOption!=NULL);

	return true;
}

//连接服务器
bool CRoomViewItem::ConnectGameServer()
{
	m_ServiceStatus=ServiceStatus_Connecting;
	tagGameServer * pGameServer=m_pListServer->GetItemInfo();
	m_ClientSocket->SetProxyServer(CDlgLogon::m_ProxyInfo);
	return m_ClientSocket->Connect(pGameServer->dwServerAddr,pGameServer->wServerPort);
}

//发送规则
bool CRoomViewItem::SendUserRule()
{
	if (m_ServiceStatus!=ServiceStatus_Serviceing) return false;
	return SendUserRulePacket();
}

//私语信息
bool CRoomViewItem::SendUserWhisper(IUserItem * pIUserItem)
{
	//获取用户
	ASSERT(pIUserItem!=NULL);
	if (pIUserItem==NULL) return false;

	//激活窗口
	CShortMessage *pShortMessageWnd = ActiveShortWnd(pIUserItem->GetUserData()->dwUserID,pIUserItem,true);
	if (pShortMessageWnd==NULL)	ShowMessageBox(TEXT("短信息窗口太多了，请关闭部分短信息窗口再试！"),MB_ICONINFORMATION);

	return true;
}


//用户SHOW信息
bool CRoomViewItem::SendUserShow(IUserItem * pIUserItem)
{
	//获取用户
	ASSERT(pIUserItem!=NULL);
	if (pIUserItem==NULL) return false;

	CShow *pShowWnd = ActiveShowWnd(pIUserItem->GetUserData()->dwUserID,pIUserItem,true);
	if (pShowWnd==NULL)	ShowMessageBox(TEXT("用户SHOW窗口太多了，请关闭部分窗口再试！"),MB_ICONINFORMATION);

	return true;
}



//用户菜单
bool CRoomViewItem::ShowUserInfoMenu(IUserItem * pIUserItem, CPoint Point)
{
	//判断状态
	if (m_ServiceStatus!=ServiceStatus_Serviceing) return false;

	//用户判断
	if (pIUserItem==NULL) 
	{
		m_MessageProxyHelper->InsertGeneralString(TEXT("此用户已经离开房间了 "),RGB(0,0,0),MS_NORMAL,true);
		return false;
	}

	//构造菜单
	CMenu UserInfoMenu;
	if (UserInfoMenu.CreatePopupMenu()==FALSE) return false;

	//获取玩家
	tagUserData * pUserData=pIUserItem->GetUserData();
	tagUserData * pMeUserData=m_pMeUserItem->GetUserData();

	//用户信息
	WORD wTableID=pUserData->wTableID;
	WORD wChiarID=pUserData->wChairID;
	BYTE cbUserStatus=pUserData->cbUserStatus;

	//玩家信息
	WORD wMeTableID=pMeUserData->wTableID;
	WORD wMeChiarID=pMeUserData->wChairID;
	BYTE cbMeUserStatus=pMeUserData->cbUserStatus;

	//设置变量
	TCHAR szBuffer[256]=TEXT("");
	m_dwMenuUserID=pUserData->dwUserID;
	bool bMySelf=(pIUserItem==m_pMeUserItem);

	////常用菜单
	//if (bMySelf==false) 
	//{
	//	UserInfoMenu.AppendMenu(0,IDM_UM_WISPER,TEXT("发短私聊信息..."));
	//	UserInfoMenu.SetDefaultItem(IDM_UM_WISPER,MF_BYCOMMAND);
	//}
	UserInfoMenu.AppendMenu(0,IDM_UM_COPY_NAME,TEXT("拷贝用户名"));

	//聊天对象
	if ((bMySelf==false)&&(m_dwChatUserID!=pUserData->dwUserID))
	{
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("与 [ %s ] 交谈"),pUserData->szName);
		UserInfoMenu.AppendMenu(0,IDM_UM_SET_CHAT,szBuffer);
	}
	if (m_szChatName[0]!=0)
	{
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("取消与 [ %s ] 交谈"),m_szChatName);
		UserInfoMenu.AppendMenu(0,IDM_UM_CANECL_CHAT,szBuffer);
	}

	//查看位置
	UserInfoMenu.AppendMenu(MF_SEPARATOR);
	
	if (bMySelf==false) UserInfoMenu.AppendMenu(0,IDM_UM_LOOK_LOCATION,TEXT("查看玩家的位置"));
	else UserInfoMenu.AppendMenu(0,IDM_UM_LOOK_LOCATION,TEXT("查看我的位置"));
	if (pUserData->wTableID==INVALID_TABLE) UserInfoMenu.EnableMenuItem(IDM_UM_LOOK_LOCATION,MF_BYCOMMAND|MF_GRAYED);

	//邀请游戏
	if ((bMySelf==false)&&(cbMeUserStatus!=US_PLAY)&&(wMeTableID!=INVALID_TABLE)&&(cbUserStatus<US_PLAY))
	{
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("邀请 [ %s ] 一起游戏"),pUserData->szName);
		UserInfoMenu.AppendMenu(0,IDM_UM_INVITE_PLAY,szBuffer);
	}

	//功能菜单
//	UserInfoMenu.AppendMenu(MF_SEPARATOR);
//	UserInfoMenu.AppendMenu(0,IDM_UM_SEARCH_USER,TEXT("寻找玩家..."));
	if(bMySelf==false)
	{
		UserInfoMenu.AppendMenu(0,IDM_UM_SET_FRIEND,TEXT("设为好友"));
		UserInfoMenu.AppendMenu(0,IDM_UM_SET_DETEST,TEXT("设为厌恶"));
		if (pUserData->cbCompanion==enCompanion_Friend) 
		{
			UserInfoMenu.CheckMenuItem(IDM_UM_SET_FRIEND,MF_BYCOMMAND|MF_CHECKED);
		}
		if (pUserData->cbCompanion==enCompanion_Detest) 
		{
			UserInfoMenu.CheckMenuItem(IDM_UM_SET_DETEST,MF_BYCOMMAND|MF_CHECKED);
		}
	}

	//玩家信息
	double dFleeRate=0.0;
	LONG lPlayCount=pIUserItem->GetUserPlayCount();
	if (pUserData->lFleeCount>0)
	{
		dFleeRate=(double)(pUserData->lFleeCount*100)/(double)lPlayCount;
		if (dFleeRate<0.01) dFleeRate=0.0;
	}

	//if(bMySelf==false)
	//{
	//	UserInfoMenu.AppendMenu(0,MF_SEPARATOR);
	//	//用户形象SHOW
	//	UserInfoMenu.AppendMenu(0,IDM_UM_SHOW,TEXT("个人形象SHOW"));
	//	UserInfoMenu.SetDefaultItem(IDM_UM_SHOW,MF_BYCOMMAND);	
	//}

	//玩家名字
	UserInfoMenu.AppendMenu(0,MF_SEPARATOR);
	LPCTSTR pszMember[]={TEXT("普通会员"),TEXT("中级会员"),TEXT("高级会员")};
	if ((pUserData->cbMember>0)&&(pUserData->cbMember<CountArray(pszMember)))
	{
		BYTE cbMember=pUserData->cbMember;
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("用户名：%s [ %s ]"),pUserData->szName,pszMember[cbMember]);
	}
	else 
	{
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("用户名：%s"),pUserData->szName);
	}
	UserInfoMenu.AppendMenu(0,0,szBuffer);

	
	//游戏 ID
	_snprintf(szBuffer,CountArray(szBuffer),TEXT("ID 号：%ld"),pUserData->dwUserID);
	UserInfoMenu.AppendMenu(0,0,szBuffer);
	
	//经验数值
	_snprintf(szBuffer,CountArray(szBuffer),TEXT("经验值：%ld"),pUserData->lExperience);
	UserInfoMenu.AppendMenu(0,0,szBuffer);
	
	//玩家位置
	if (pUserData->wTableID!=INVALID_TABLE)
	{
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("桌号：%d"),pUserData->wTableID+1);
		UserInfoMenu.AppendMenu(0,0,szBuffer);
	}

	//游戏币信息
	_snprintf(szBuffer,CountArray(szBuffer),TEXT("游戏币：%ld  总局数：%ld  逃跑率：%5.2f%%"),pUserData->lScore,lPlayCount,dFleeRate);
	UserInfoMenu.AppendMenu(0,0,szBuffer);

	//社团信息
	if (pUserData->szGroupName[0]!=0)
	{
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("社团：%s"),pUserData->szGroupName);
		UserInfoMenu.AppendMenu(0,0,szBuffer);
	}

	//用户管理
	if ((pMeUserData->dwUserID!=m_dwMenuUserID)&&(pMeUserData->dwMasterRight!=0L))
	{
		//插入菜单
		UserInfoMenu.AppendMenu(0,MF_SEPARATOR);
		UserInfoMenu.AppendMenu(0,IDM_UM_SEND_WARNNING,TEXT("发送警告信息..."));
		UserInfoMenu.AppendMenu(0,IDM_UM_LOOK_USER_IP,TEXT("查看用户 IP..."));
		UserInfoMenu.AppendMenu(0,IDM_UM_CUT_USER,TEXT("踢用户下线..."));
		UserInfoMenu.AppendMenu(0,IDM_UM_LIMIT_ACCOUN,TEXT("禁用用户帐号..."));
		UserInfoMenu.AppendMenu(0,IDM_UM_MANAGER_USER,TEXT("用户权限设置..."));

		//禁止菜单
		DWORD dwMasterRight=pMeUserData->dwMasterRight;
		if (CUserRight::CanSendWarning(dwMasterRight)==false) UserInfoMenu.EnableMenuItem(IDM_UM_SEND_WARNNING,MF_BYCOMMAND|MF_GRAYED);
		if (CUserRight::CanSeeUserIP(dwMasterRight)==false) UserInfoMenu.EnableMenuItem(IDM_UM_LOOK_USER_IP,MF_BYCOMMAND|MF_GRAYED);
		if (CUserRight::CanCutUser(dwMasterRight)==false) UserInfoMenu.EnableMenuItem(IDM_UM_CUT_USER,MF_BYCOMMAND|MF_GRAYED);
		if (CUserRight::CanForbidAccounts(dwMasterRight)==false) UserInfoMenu.EnableMenuItem(IDM_UM_LIMIT_ACCOUN,MF_BYCOMMAND|MF_GRAYED);
	}

	//房间管理
	if (pMeUserData->dwMasterRight!=0L)
	{
		//插入菜单
		UserInfoMenu.AppendMenu(0,MF_SEPARATOR);
		UserInfoMenu.AppendMenu(0,IDM_UM_ISSUE_MESSAGE,TEXT("发布系统消息..."));
		UserInfoMenu.AppendMenu(0,IDM_IM_SYSTEM_OPTION,TEXT("游戏房间配置..."));

		//禁止菜单
		DWORD dwMasterRight=pMeUserData->dwMasterRight;
		if (CUserRight::CanIssueMessage(dwMasterRight)==false) UserInfoMenu.EnableMenuItem(IDM_UM_ISSUE_MESSAGE,MF_BYCOMMAND|MF_GRAYED);
		if (CUserRight::CanServerOption(dwMasterRight)==false) UserInfoMenu.EnableMenuItem(IDM_IM_SYSTEM_OPTION,MF_BYCOMMAND|MF_GRAYED);
	}

	//显示菜单
	//UserInfoMenu.SetMenuDrawMode(BCMENU_DRAWMODE_XP); // 用XP格式显示
	UserInfoMenu.TrackPopupMenu(TPM_LEFTALIGN|TPM_LEFTBUTTON,Point.x,Point.y,this);

	return true;
}

//发送登陆包
bool CRoomViewItem::SendLogonPacket()
{
	//获取信息
	BYTE cbBuffer[SOCKET_PACKAGE];
	tagGlobalUserData & GlobalUserData=g_GlobalUnits.GetGolbalUserData();

	//登陆数据包
	CMD_GR_LogonByUserID * pLogonByUserID=(CMD_GR_LogonByUserID *)cbBuffer;
	pLogonByUserID->dwUserID=GlobalUserData.dwUserID;
	pLogonByUserID->dwPlazaVersion=g_GlobalUnits.GetPlazaVersion();
	lstrcpyn(pLogonByUserID->szPassWord,GlobalUserData.szPassWord,sizeof(pLogonByUserID->szPassWord));

	//机器序列号
	tagClientSerial ClientSerial;
	g_GlobalUnits.GetClientSerial(ClientSerial);

	//发送数据包
	CSendPacketHelper Packet(cbBuffer+sizeof(CMD_GR_LogonByUserID),sizeof(cbBuffer)-sizeof(CMD_GR_LogonByUserID));
	Packet.AddPacket(&ClientSerial,sizeof(ClientSerial),DTP_COMPUTER_ID);
	m_ClientSocket->SendData(MDM_GR_LOGON,SUB_GR_LOGON_USERID,cbBuffer,sizeof(CMD_GR_LogonByUserID)+Packet.GetDataSize());

	return true;
}

//发送设置命令
bool CRoomViewItem::SendOptionsPacket()
{
	return true;
}

//发送起来命令
bool CRoomViewItem::SendStandUpPacket()
{
	m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_STANDUP_REQ);

	return true;
}

//发送强退命令
bool CRoomViewItem::SendLeftGamePacket()
{
	m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_LEFT_GAME_REQ);

	return true;
}

//发送房间规则
bool CRoomViewItem::SendUserRulePacket()
{
	//构造数据包
	CMD_GR_UserRule UserRule;
	UserRule.bLimitWin=m_pGameOption->m_bLimitWin;
	UserRule.bLimitFlee=m_pGameOption->m_bLimitFlee;
	UserRule.wWinRate=m_pGameOption->m_wWinRate;
	UserRule.wFleeRate=m_pGameOption->m_wFleeRate;
	UserRule.wNetDelay=m_pGameOption->m_wNetDelay;
	UserRule.lMaxScore=m_pGameOption->m_lMaxScore;
	UserRule.lLessScore	=m_pGameOption->m_lLessScore;
	UserRule.bLimitScore=m_pGameOption->m_bLimitScore;
	UserRule.bLimitDelay=m_pGameOption->m_bLimitDelay;
	UserRule.bPassword=m_pServerOption->m_bPassword;
	UserRule.bCheckSameIP=g_GlobalOption.m_bCheckSameIP;
	lstrcpyn(UserRule.szPassword,m_pServerOption->m_szPassword,CountArray(UserRule.szPassword));

	//发送数据包
	m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_RULE,&UserRule,sizeof(UserRule));

	return true;
}

//发送旁观命令
bool CRoomViewItem::SendLookonPacket(WORD wTableID, WORD wChairID, LPCTSTR pszTablePass)
{
	//构造数据包
	CMD_GR_UserSitReq UserUserSitReq;
	memset(&UserUserSitReq,0,sizeof(UserUserSitReq));
	UserUserSitReq.wTableID=wTableID;
	UserUserSitReq.wChairID=wChairID;
	UserUserSitReq.wNetTimelag=0;
	lstrcpyn(UserUserSitReq.szTablePass,pszTablePass,sizeof(UserUserSitReq.szTablePass));
	UserUserSitReq.cbPassLen=CountString(UserUserSitReq.szTablePass);

	//发送数据包
	WORD wSendSize=sizeof(UserUserSitReq)-sizeof(UserUserSitReq.szTablePass)+UserUserSitReq.cbPassLen;
	m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_LOOKON_REQ,&UserUserSitReq,wSendSize);

	return true;
}

//发送坐下命令
bool CRoomViewItem::SendSitDownPacket(WORD wTableID, WORD wChairID, LPCTSTR pszTablePass)
{
	//构造数据包
	CMD_GR_UserSitReq UserSitReq;
	memset(&UserSitReq,0,sizeof(UserSitReq));
	UserSitReq.wTableID=wTableID;
	UserSitReq.wChairID=wChairID;
	UserSitReq.wNetTimelag=0;
	lstrcpyn(UserSitReq.szTablePass,pszTablePass,sizeof(UserSitReq.szTablePass));
	UserSitReq.cbPassLen=CountString(UserSitReq.szTablePass);

	//发送数据包
	WORD wSendSize=sizeof(UserSitReq)-sizeof(UserSitReq.szTablePass)+UserSitReq.cbPassLen;
	m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_SIT_REQ,&UserSitReq,wSendSize);

	return true;
}

//旁观动作
bool CRoomViewItem::PerformLookonAction(WORD wTableID, WORD wChairID)
{
	//bluker:由服务器分配位置
	if(IsServerAllocTable())
	{
		m_wReqTableID=INVALID_TABLE;
		m_wReqChairID=INVALID_CHAIR;
		SendSitDownPacket(1,1,m_pServerOption->m_bPassword?m_pServerOption->m_szPassword:NULL);
		return true;
	}
	//效验数据
	ASSERT(wTableID!=INVALID_TABLE);
	ASSERT(wChairID!=INVALID_CHAIR);

	//动作效验
	if (CanSitDownTable(wTableID,wChairID,true,true)==false) return false;

	//清理界面
	if ((m_wReqTableID!=INVALID_TABLE)&&(m_wReqChairID!=INVALID_CHAIR))
	{
		IUserItem * pIUserItem=m_TableFrame.GetUserInfo(m_wReqTableID,m_wReqChairID);
		if (pIUserItem==m_pMeUserItem) m_TableFrame.SetUserInfo(m_wReqTableID,m_wReqChairID,NULL);
	}

	//动作处理

	m_wReqTableID=wTableID;
	m_wReqChairID=wChairID;
	m_wFindTableID=INVALID_TABLE;
	m_TableFrame.EnsureVisibleTable(wTableID);
	SendLookonPacket(wTableID,wChairID,NULL);

	return true;
}

//坐下动作
bool CRoomViewItem::PerformSitDownAction(WORD wTableID, WORD wChairID)
{
	if(IsServerAllocTable())
	{
		m_wReqTableID=INVALID_TABLE;
		m_wReqChairID=INVALID_CHAIR;
		SendSitDownPacket(1,1,m_pServerOption->m_bPassword?m_pServerOption->m_szPassword:NULL);
		return true;
	}
	//效验数据
	ASSERT(wTableID!=INVALID_TABLE);
	ASSERT(wChairID!=INVALID_CHAIR);

	//动作效验
	if (CanSitDownTable(wTableID,wChairID,false,true)==false) return false;

	//清理界面
	if ((m_wReqTableID!=INVALID_TABLE)&&(m_wReqChairID!=INVALID_CHAIR))
	{
		IUserItem * pIUserItem=m_TableFrame.GetUserInfo(m_wReqTableID,m_wReqChairID);
		if (pIUserItem==m_pMeUserItem) m_TableFrame.SetUserInfo(m_wReqTableID,m_wReqChairID,NULL);
	}

	//动作处理
	m_wReqTableID=wTableID;
	m_wReqChairID=wChairID;
	m_wFindTableID=INVALID_TABLE;
	m_TableFrame.EnsureVisibleTable(wTableID);
	m_TableFrame.SetUserInfo(wTableID,wChairID,m_pMeUserItem);
	SendSitDownPacket(wTableID,wChairID,m_pServerOption->m_bPassword?m_pServerOption->m_szPassword:NULL);

	return true;
}

//发送聊天命令
bool CRoomViewItem::SendChatPacket(DWORD dwTargetUserID, LPCTSTR pszChatMessage, COLORREF crFontColor)
{
	//获取用户
	ASSERT(m_pMeUserItem!=NULL);
	tagUserData * pUserData=m_pMeUserItem->GetUserData();

	//构造数据
	CMD_GR_UserChat UserChat;
	UserChat.crFontColor=crFontColor;
	UserChat.dwTargetUserID=dwTargetUserID;
	UserChat.dwSendUserID=pUserData->dwUserID;
	lstrcpyn(UserChat.szChatMessage,pszChatMessage,CountArray(UserChat.szChatMessage));
	UserChat.wChatLength=CountString(UserChat.szChatMessage);

	//发送命令
	WORD wSendSize=sizeof(UserChat)-sizeof(UserChat.szChatMessage)+UserChat.wChatLength;
	m_ClientSocket->SendData(MDM_GR_USER,SUB_GR_USER_CHAT,&UserChat,wSendSize);

	return true;
}

//发送游戏信息
bool CRoomViewItem::IPCSendGameInfo(CIPCSendCopyData * pSendCopyData)
{
	//效益参数
	ASSERT(pSendCopyData!=NULL);
	ASSERT(m_pMeUserItem!=NULL);

	//定义变量
	tagUserData * pUserData=m_pMeUserItem->GetUserData();
	CListKind * pListKind=m_pListServer->GetListKind();
	tagGameKind * pGameKind=pListKind->GetItemInfo();
	tagGameServer * pGameServer=m_pListServer->GetItemInfo();

	//构造数据
	IPC_GF_ServerInfo ServerInfo;
	memset(&ServerInfo,0,sizeof(ServerInfo));
	ServerInfo.dwUserID=pUserData->dwUserID;
	ServerInfo.wTableID=pUserData->wTableID;
	ServerInfo.wChairID=pUserData->wChairID;
	ServerInfo.wKindID=pGameKind->wKindID;
	ServerInfo.wServerID=pGameServer->wServerID;
	ServerInfo.wGameGenre=m_wGameGenre;
	ServerInfo.wChairCount=m_TableFrame.GetChairCount();
	CopyMemory(&ServerInfo.OptionBuffer,&m_OptionBuffer,sizeof(ServerInfo.OptionBuffer));
	lstrcpyn(ServerInfo.szKindName,pGameKind->szKindName,CountArray(ServerInfo.szKindName));
	lstrcpyn(ServerInfo.szServerName,pGameServer->szServerName,CountArray(ServerInfo.szServerName));

	//发送数据
	pSendCopyData->SendData(IPC_MAIN_CONFIG,IPC_SUB_SERVER_INFO,&ServerInfo,sizeof(ServerInfo));

	return true;
}

//发送用户
bool CRoomViewItem::IPCSendTableUsers(CIPCSendCopyData * pSendCopyData)
{
	//效益参数
	ASSERT(pSendCopyData!=NULL);

	//发送自己信息
	ASSERT(m_pMeUserItem!=NULL);
	tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
	ASSERT(pMeUserData->wTableID!=(WORD)INVALID_TABLE);
	if (pMeUserData->wTableID==(WORD)INVALID_TABLE) return false;
	SendTableUser(m_pMeUserItem,pSendCopyData);

	//发送其他用户
	IUserItem * pIUserItem=NULL;
	tagUserData * pUserData=NULL;

	//游戏用户
	WORD wEnumIndex=0;
	while (true)
	{
		pIUserItem=m_ClientUserManager.EnumUserItem(wEnumIndex++);
		if (pIUserItem==NULL) break;
		if (pIUserItem==m_pMeUserItem) continue;
		pUserData=pIUserItem->GetUserData();
		if ((pUserData->wTableID==pMeUserData->wTableID)&&(pUserData->cbUserStatus!=US_LOOKON))
			SendTableUser(pIUserItem,pSendCopyData);
	};

	//旁观用户
	wEnumIndex=0;
	while (true)
	{
		pIUserItem=m_ClientUserManager.EnumUserItem(wEnumIndex++);
		if (pIUserItem==NULL) break;
		if (pIUserItem==m_pMeUserItem) continue;
		pUserData=pIUserItem->GetUserData();
		if ((pUserData->wTableID==pMeUserData->wTableID)&&(pUserData->cbUserStatus==US_LOOKON))
			SendTableUser(pIUserItem,pSendCopyData);
	};

	return true;
}

//启动游戏
int CRoomViewItem::StartGameClient()
{
	g_GlobalOption.CloseMedia();
	//判断是否已经启动
	ASSERT(m_pShareMemory!=NULL);
	if ((g_GameProcessInfo.hProcess!=NULL)&&(WaitForSingleObject(g_GameProcessInfo.hProcess,0)==WAIT_TIMEOUT))
	{
		if (m_pShareMemory->hWndGameFrame!=NULL)
		{
			//显示窗口
			::ShowWindow(m_pShareMemory->hWndGameFrame,SW_SHOW);
			::SetForegroundWindow(m_pShareMemory->hWndGameFrame);

			//发送信息
			CIPCSendCopyData SendCopyData(m_hWndChannel,m_hWnd);
			IPCSendGameInfo(&SendCopyData);
			IPCSendTableUsers(&SendCopyData);
			SendCopyData.SendData(IPC_MAIN_CONCTROL,IPC_SUB_START_FINISH);

			return SR_ALREADY_EXIST;
		}
		else ::TerminateProcess(g_GameProcessInfo.hProcess,0);
	}

	//清理数据
	m_hWndChannel=NULL;
	m_pShareMemory->hWndGameFrame=NULL;
	CloseHandle(g_GameProcessInfo.hThread);
	CloseHandle(g_GameProcessInfo.hProcess);
	memset(&g_GameProcessInfo,0,sizeof(g_GameProcessInfo));


	//构造命令行
	CString strCommonLine;
	CListKind * pListKind=m_pListServer->GetListKind();
	tagGameKind * pGameKind=pListKind->GetItemInfo();
	strCommonLine.Format(TEXT("%s /RoomToken:%s /ServerType:%ld /WndPlaza:%d /AutoStart:%d /Title:\"%s\" /sid:%s"),
			pGameKind->szProcessName,
			m_szShareName,
			m_wGameGenre,
			::AfxGetMainWnd()->m_hWnd,IsServerAllocTable(),
			(LPCSTR)g_szGameTitle,
			g_GlobalUnits.GetGolbalUserData().szSessionId);

	//启动游戏客户端
	STARTUPINFO StartInfo;
	memset(&StartInfo,0,sizeof(StartInfo));
	StartInfo.cb=sizeof(StartInfo);
	StartInfo.wShowWindow=SW_SHOWMAXIMIZED;
	BOOL bSuccess=CreateProcess(NULL,strCommonLine.GetBuffer(),NULL,NULL,FALSE,CREATE_DEFAULT_ERROR_MODE,NULL,NULL,&StartInfo,&g_GameProcessInfo);
	strCommonLine.ReleaseBuffer();
	if (bSuccess==FALSE)
	{
		memset(&g_GameProcessInfo,0,sizeof(g_GameProcessInfo));
		return SR_CREATE_ERROR;
	}

	return SR_CREATE_SUCCESS;
}

//关闭游戏
void CRoomViewItem::CloseGameClient()
{
	//发送消息
	if (g_GameProcessInfo.hProcess!=NULL)
	{
		SendProcessData(IPC_MAIN_CONCTROL,IPC_SUB_CLOSE_FRAME,NULL,0);
		DWORD dwResult=::WaitForSingleObject(g_GameProcessInfo.hProcess,1000);
		if (dwResult==WAIT_TIMEOUT) ::TerminateProcess(g_GameProcessInfo.hProcess,0);
	}

	//清理数据
	m_hWndChannel=NULL;
	m_pShareMemory->hWndGameFrame=NULL;
	CloseHandle(g_GameProcessInfo.hThread);
	CloseHandle(g_GameProcessInfo.hProcess);
	memset(&g_GameProcessInfo,0,sizeof(g_GameProcessInfo));

	return;
}

//更新标题
void CRoomViewItem::UpdateTitleText()
{
	//刷新界面
	//CRect rcInvalidate;
	//rcInvalidate.SetRect(0,0,rcVorSplitter.left-BUTTON_AREA_WIDTH,TABLE_TOP);
	//InvalidateRect(&rcInvalidate);

	return;
}

//左视图区
void CRoomViewItem::DrawLeftViewFrame(CDC * pDC)
{

	//获取位置
	CRect rcClient;
	GetClientRect(&rcClient);

	//变量定义
	HDC hDC=pDC->m_hDC;
	int nXPos=0,nYPos=0;

	//加载资源

	CImageHandle m_ImageTopHandle(&m_ImageTop);

	CImageHandle m_ImageInfoHandle(&m_ImageInfo);
	CImageHandle m_ImageWebHandle(&m_ImageWeb);

	CImageHandle m_ImageMLHandle(&m_ImageML);
	CImageHandle m_ImageMRHandle(&m_ImageMR);

	CImageHandle ImageChatTLHandle(&m_ImageChatTL);
	CImageHandle ImageChatTMHandle(&m_ImageChatTM);
	CImageHandle ImageChatTRHandle(&m_ImageChatTR);

	CImageHandle QQShowLHandle(&m_QQShowL);
	CImageHandle QQShowRHandle(&m_QQShowR);
	CImageHandle QQShowBHandle(&m_QQShowB);

	m_ImageTop.BitBlt(hDC,m_UserListView.GetWidth()+2,0);

	m_ImageML.StretchBlt(hDC,
			CRect(0,0,m_ImageML.GetWidth(),rcClient.bottom),
			CRect(0,0,m_ImageML.GetWidth(),m_ImageML.GetHeight())
			);
	m_ImageMR.StretchBlt(hDC,
		CRect(rcClient.right-m_ImageMR.GetWidth(),0,rcClient.right,rcClient.bottom),
		CRect(0,0,m_ImageMR.GetWidth(),m_ImageMR.GetHeight())
			);

	m_ImageInfo.StretchBlt(hDC,
		CRect(2,0,m_ImageInfo.GetWidth()+2,m_ImageInfo.GetHeight()),
		CRect(0,0,m_ImageInfo.GetWidth(),m_ImageInfo.GetHeight())
		);
	CRect cr;
	GetClientRect(cr);
	m_ImageWeb.StretchBlt(hDC,
		CRect(2,cr.Height()-98,m_ImageInfo.GetWidth()+2,cr.Height()-98+m_ImageInfo.GetHeight()),
		CRect(0,0,m_ImageInfo.GetWidth(),m_ImageInfo.GetHeight())
		);




	//QQShow窗口
	//m_QQShowL.BitBlt(hDC,m_ImageML.GetWidth(),m_UserListView.GetHeight());
	//m_QQShowR.BitBlt(hDC,m_ImageML.GetWidth()+m_UserListView.GetWidth() - m_QQShowR.GetWidth(),m_UserListView.GetHeight());
	//m_QQShowB.BitBlt(hDC,m_ImageML.GetWidth(),rcClient.bottom - m_QQShowB.GetHeight());


	//聊天窗口
	///*
	//m_ImageChatTM.StretchBlt(hDC,
	//		CRect(m_UserListView.GetWidth()+231,rcClient.bottom-CHAT_HEIGHT,rcClient.right-13,rcClient.bottom),
	//		CRect(0,0,m_ImageChatTM.GetWidth(),m_ImageChatTM.GetHeight())
	//		);

	//m_ImageChatTL.BitBlt(hDC,m_UserListView.GetWidth()+5,rcClient.bottom-CHAT_HEIGHT);
	//m_ImageChatTR.BitBlt(hDC,rcClient.right-13,rcClient.bottom-CHAT_HEIGHT);


	m_ImageChatTL.BitBlt(hDC,m_UserListView.GetWidth()+2,rcClient.bottom-CHAT_HEIGHT);
	m_ImageChatTM.StretchBlt(hDC,
			CRect(m_UserListView.GetWidth()+291,rcClient.bottom-CHAT_HEIGHT,rcClient.right-326,rcClient.bottom),
			CRect(0,0,m_ImageChatTM.GetWidth(),CHAT_HEIGHT)
			);
	m_ImageChatTR.BitBlt(hDC,rcClient.right-326,rcClient.bottom-CHAT_HEIGHT);


//*/
/*
	//房间标题
	TCHAR szRoomTitle[128]=TEXT("");
	CListKind * pListKind=m_pListServer->GetListKind();
	_snprintf(szRoomTitle,sizeof(szRoomTitle),TEXT("[%s]%s(%ld人)"),pListKind->GetItemInfo()->szKindName,
		m_pListServer->GetItemInfo()->szServerName,m_ClientUserManager.GetOnLineCount());

	//输出标题
	pDC->SetBkMode(TRANSPARENT);
	pDC->SetTextColor(RGB(10,10,10));
	pDC->SelectObject(&CSkinAttribute::m_DefaultFont);
	CRect rcTitle(35,38,205,50);
	pDC->DrawText(szRoomTitle,lstrlen(szRoomTitle),&rcTitle,DT_END_ELLIPSIS|DT_VCENTER|DT_SINGLELINE);
*/

	tagGlobalUserData & UserData=g_GlobalUnits.GetGolbalUserData();

	if (UserData.dwUserID!=0)
	{
		CRect cr;
		GetClientRect(cr);
		//设置 DC
		pDC->SetBkMode(TRANSPARENT);
		pDC->SelectObject(CSkinAttribute::m_DefaultFont);

		//用户名字
		TCHAR szBuffer[128];
		pDC->SetTextColor(RGB(255,255,255));
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("%s"),UserData.szAccounts);
		pDC->TextOut(80,42,szBuffer,lstrlen(szBuffer));

		//用户号码
		//_snprintf(szBuffer,CountArray(szBuffer),TEXT("社团：%s"),UserData.szGroupName);
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("社团：%s"),UserData.szGroupName);
		pDC->TextOut(80,62,szBuffer,lstrlen(szBuffer));

		LPCTSTR pszMember[]={TEXT("普通会员"),TEXT("中级会员"),TEXT("高级会员")};
		BYTE cbMember=UserData.cbMember;
		_snprintf(szBuffer,CountArray(szBuffer),TEXT("%s"),pszMember[cbMember]);
		pDC->TextOut(80,82,szBuffer,lstrlen(szBuffer));
		//CRect re;

		//GetWindowRect(re);
		//CString aa;
		//aa.Format("%d,%d",re.right,re.bottom);
		//MessageBox(aa);
		//用户头像
		g_GlobalUnits.m_UserFaceRes->DrawBigFace(pDC,14,42,UserData.wFaceID);
	}//

	return;
}

//查找桌子
bool CRoomViewItem::FindGameTable(tagFindTable & FindInfo)
{
	//变量定义
	WORD wNullCount=0;
	ITableView * pTableView=NULL;
	WORD wChairUser=m_TableFrame.GetChairCount();
	WORD wMeTableID=m_pMeUserItem->GetUserData()->wTableID;

	//搜索桌子
	for (WORD i=0;i<m_TableFrame.GetTableCount();i++)
	{
		FindInfo.wResultTableID=(FindInfo.wBeginTableID+i)%m_TableFrame.GetTableCount();
		if (wMeTableID!=FindInfo.wResultTableID)
		{
			//获取桌子
			pTableView=m_TableFrame.GetTableArrayPtr(FindInfo.wResultTableID);
			ASSERT(pTableView!=NULL);

			//判断是否开始游戏
			if (pTableView->QueryPlayFlag()==true) continue;

			//过滤密码
			bool bTablePass=pTableView->QueryPassFlag();
			if ((FindInfo.bFilterPass==true)&&(bTablePass==true)) continue;

			//寻找空位置
			wNullCount=pTableView->GetNullChairCount(FindInfo.wResultChairID);

			//效验规则
			if (CanSitDownTable(FindInfo.wResultTableID,FindInfo.wResultChairID,false,false)==false) continue;

			//判断数目
			if (wNullCount>0)
			{
				if ((FindInfo.bNotFull==true)&&(wNullCount<wChairUser)) return true;
				if ((FindInfo.bOneNull==true)&&(wNullCount==1)) return true;
				if ((FindInfo.bTwoNull==true)&&(wNullCount==2)) return true;
				if ((FindInfo.bAllNull==true)&&(wNullCount==wChairUser)) return true;
			}
		}
	}

	//设置数据
	FindInfo.wResultTableID=INVALID_TABLE;
	FindInfo.wResultChairID=INVALID_CHAIR;

	return false;
}

//调整控件
void CRoomViewItem::RectifyControl(int nWidth, int nHeight)
{
	//状态判断
	if (m_bInitDialog==false) return;
	if ((nWidth==0)||(nHeight==0)) return;

	//变量定义
	const UINT uFlags=SWP_NOACTIVATE|SWP_NOZORDER|SWP_NOCOPYBITS;

	//移动控件
	HDWP hDwp=BeginDeferWindowPos(32);

	//QQShow
	//DeferWindowPos(hDwp,m_pHtmlBrower->GetSafeHwnd(),NULL,43,nHeight-233,140,226,uFlags);

	//桌子区域
	DeferWindowPos(hDwp,m_TableFrame,NULL,2+m_UserListView.GetWidth(),27 ,nWidth - m_UserListView.GetWidth()-5,
		nHeight - CHAT_HEIGHT-27,uFlags);

	//列表区域
	//m_UserListView.SetWindowPos(NULL,5,0,0,0,SWP_NOSIZE);
	//m_UserListView.SetHeight(nHeight-233);//233为QQShow的高度
	m_UserListView.UpdateButton();

	//聊天区域
	CRect rcButton;
	int nChatTop=nHeight-CHAT_BOTTOM_DISTANCE-CHAT_HEIGHT+6;

	m_btPhrase.GetWindowRect(&rcButton);
	//CButton * pButtonArray[]={&m_btExpression,&m_btColorSet,&m_btCleanScreen};
	CButton * pButtonArray[]={&m_btSendChat,&m_btExpression,&m_btColorSet};
	for (int i=0;i<CountArray(pButtonArray);i++)
	{
		DeferWindowPos(hDwp,pButtonArray[i]->m_hWnd,NULL,m_UserListView.GetWidth()+529+i*25,nHeight - 47,rcButton.Width(),rcButton.Height(),uFlags);
	}

	DeferWindowPos(hDwp,m_ChatMessage,NULL,m_UserListView.GetWidth()+10,nChatTop+39,nWidth-m_UserListView.GetWidth()-345,CHAT_HEIGHT-69,uFlags);//消息窗
	//DeferWindowPos(hDwp,m_ChatObject,NULL,m_UserListView.GetWidth()+15,nHeight - 55,70,200,uFlags);//聊天对象选框
	//DeferWindowPos(hDwp,m_ChatInput,NULL,m_UserListView.GetWidth()+8,nHeight - 28,180 ,19,uFlags);//输入框
	DeferWindowPos(hDwp,m_ChatObject,NULL,m_UserListView.GetWidth()+307,nHeight - 45,70,200,uFlags);//聊天对象选框
	DeferWindowPos(hDwp,m_ChatInput,NULL,m_UserListView.GetWidth()+377,nHeight - 40,150 ,19,uFlags);//输入框
	m_btSendChat.GetWindowRect(&rcButton);
	//DeferWindowPos(hDwp,m_btSendChat,NULL,m_UserListView.GetWidth()+190,nHeight - 30,rcButton.Width(),rcButton.Height(),uFlags);//发送按钮


	
	int nTableCenter=m_UserListView.GetWidth() + (nWidth-m_UserListView.GetWidth())/2;
	m_btAutoSit.GetWindowRect(&rcButton);

	int RoomSpace = 62 ;
	DeferWindowPos(hDwp,m_btRoom1,NULL,m_UserListView.GetWidth()+RoomSpace+2,5,62,22,uFlags);
	DeferWindowPos(hDwp,m_btRoom2,NULL,m_UserListView.GetWidth()+RoomSpace*2+2,5,62,22,uFlags);
	DeferWindowPos(hDwp,m_btRoom3,NULL,m_UserListView.GetWidth()+RoomSpace*3+2,5,62,22,uFlags);
	DeferWindowPos(hDwp,m_btRoom4,NULL,m_UserListView.GetWidth()+RoomSpace*4+2,5,62,22,uFlags);
	DeferWindowPos(hDwp,m_btRoom5,NULL,m_UserListView.GetWidth()+RoomSpace*5+2,5,62,22,uFlags);
	DeferWindowPos(hDwp,m_btRoom6,NULL,m_UserListView.GetWidth()+RoomSpace*6+2,5,62,22,uFlags);
	//DeferWindowPos(hDwp,m_btRoomExit,NULL,m_UserListView.GetWidth()+RoomSpace*7+2,5,62,22,uFlags);
	DeferWindowPos(hDwp,m_btRoomExit,NULL,nWidth-62,5,62,22,uFlags);


	//加入按钮
	//DeferWindowPos(hDwp,m_btAutoSit,NULL,nTableCenter-130,0,rcButton.Width(),rcButton.Height(),uFlags);
	DeferWindowPos(hDwp,m_btAutoSit,NULL,m_UserListView.GetWidth()+77,nHeight-136,rcButton.Width(),rcButton.Height(),uFlags);
	//查找按钮
	//m_btFindUser.ShowWindow(SW_HIDE);
	if(IsServerAllocTable())
	{
		DeferWindowPos(hDwp,m_btFindUser,NULL,m_UserListView.GetWidth()+151,nHeight-136,rcButton.Width(),rcButton.Height(),uFlags);
		m_btFindUser.EnableWindow(false);
	}
	else
		DeferWindowPos(hDwp,m_btFindUser,NULL,m_UserListView.GetWidth()+151,nHeight-136,rcButton.Width(),rcButton.Height(),uFlags);
		//DeferWindowPos(hDwp,m_btFindUser,NULL,nTableCenter+20,0,rcButton.Width(),rcButton.Height(),uFlags);

	m_UserListView.SetHeight(nHeight-213);//y从11减了77
	m_UserListView.SetWindowPos(NULL,2,120,0,0,SWP_NOSIZE);//y从6加了71
	m_UserListView.UpdateButton();

	EndDeferWindowPos(hDwp);

	//重画界面
	Invalidate(FALSE);
	UpdateWindow();

	return;
}

//显示消息
int CRoomViewItem::ShowMessageBox(LPCTSTR pszMessage, UINT nType)
{
	tagGameServer * pGameServer=m_pListServer->GetItemInfo();
	int nResult=MessageBox(pszMessage,pGameServer->szServerName,nType);
	return nResult;
}

//发送用户
bool CRoomViewItem::SendTableUser(IUserItem * pIUserItem, CIPCSendCopyData * pSendCopyData)
{
	//效验参数
	ASSERT(pIUserItem!=NULL);
	ASSERT(pSendCopyData!=NULL);

	//定义变量
	BYTE cbBuffer[IPC_PACKAGE];
	tagUserData * pUserData=pIUserItem->GetUserData();
	tagUserInfoHead * pUserInfoHead=(tagUserInfoHead *)cbBuffer;

	//构造数据
	memset(cbBuffer,0,sizeof(cbBuffer));
	pUserInfoHead->dwUserID=pUserData->dwUserID;
	pUserInfoHead->dwGroupID=pUserData->dwGroupID;
	pUserInfoHead->dwUserRight=pUserData->dwUserRight;
	pUserInfoHead->dwMasterRight=pUserData->dwMasterRight;
	pUserInfoHead->wFaceID=pUserData->wFaceID;
	pUserInfoHead->wTableID=pUserData->wTableID;
	pUserInfoHead->wChairID=pUserData->wChairID;
	pUserInfoHead->wNetDelay=pUserData->wNetDelay;
	pUserInfoHead->cbGender=pUserData->cbGender;
	pUserInfoHead->cbMember=pUserData->cbMember;
	pUserInfoHead->cbUserStatus=pUserData->cbUserStatus;
	pUserInfoHead->UserScoreInfo.lGold=pUserData->lGold;
	pUserInfoHead->UserScoreInfo.lScore=pUserData->lScore;
	pUserInfoHead->UserScoreInfo.lWinCount=pUserData->lWinCount;
	pUserInfoHead->UserScoreInfo.lLostCount=pUserData->lLostCount;
	pUserInfoHead->UserScoreInfo.lDrawCount=pUserData->lDrawCount;
	pUserInfoHead->UserScoreInfo.lFleeCount=pUserData->lFleeCount;
	pUserInfoHead->UserScoreInfo.lExperience=pUserData->lExperience;

	//叠加数据
	WORD wHeadSize=sizeof(tagUserInfoHead);
	CSendPacketHelper SendPacketHelper(cbBuffer+wHeadSize,sizeof(cbBuffer)-wHeadSize);
	SendPacketHelper.AddPacket(pUserData->szName,CountString(pUserData->szName),DTP_USER_ACCOUNTS);
	SendPacketHelper.AddPacket(&pUserData->cbCompanion,sizeof(pUserData->cbCompanion),DTP_USER_COMPANION);
	SendPacketHelper.AddPacket(pUserData->szGroupName,CountString(pUserData->szGroupName),DTP_USER_GROUP_NAME);
	
	//发送数据
	WORD wSendSize=wHeadSize+SendPacketHelper.GetDataSize();
	pSendCopyData->SendData(IPC_MAIN_USER,IPC_SUB_USER_COME,cbBuffer,wSendSize);

	return true;
}

//发送消息
bool CRoomViewItem::SendProcessData(WORD wMainCmdID, WORD wSubCmdID, void * pBuffer, WORD wDataSize)
{
	//发送消息
	CIPCSendCopyData IPCSendCopyData(m_hWndChannel,m_hWnd);
	return IPCSendCopyData.SendData(wMainCmdID,wSubCmdID,pBuffer,wDataSize);
}

//能否坐下
bool CRoomViewItem::CanSitDownTable(WORD wTableID, WORD wChairID, bool bLookon, bool bShowError)
{
	//效验参数
	ASSERT(wTableID!=INVALID_TABLE);
	ASSERT(wChairID!=INVALID_CHAIR);
	if (wTableID>=m_TableFrame.GetTableCount()) return false;
	if (wChairID>=m_TableFrame.GetChairCount()) return false;
	if (m_ServiceStatus!=ServiceStatus_Serviceing) return false;

	//判断响应
	if ((m_wReqTableID!=INVALID_TABLE)||(m_wReqChairID!=INVALID_CHAIR))
	{
		if (bShowError==true)
		{
			LPCTSTR pszDescribe=TEXT("上次请求还没有收到服务器回应,请稍候！");
			ShowMessageBox(pszDescribe,MB_ICONINFORMATION);
			return false;
		}
	}

	//判断玩家
	ITableView * pITableView=m_TableFrame.GetTableArrayPtr(wTableID);
	IUserItem * pITableUserItem=pITableView->GetUserInfo(wChairID);
	if ((bLookon==true)&&(pITableUserItem==NULL)) return false;
	if ((bLookon==false)&&(pITableUserItem!=NULL)) return false;

	//判断状态
	BYTE cbUserStatus=m_pMeUserItem->GetUserData()->cbUserStatus;
	if (cbUserStatus==US_PLAY)
	{
		if (bShowError==true)
		{
			LPCTSTR pszDescribe=TEXT("你正在游戏中，暂时不能换位置，请先结束游戏！");
			ShowMessageBox(pszDescribe,MB_ICONINFORMATION);
		}
		return false;
	}

	//判断游戏状态
	bool bGameStart=pITableView->QueryPlayFlag();
	if ((bGameStart==true)&&(bLookon==false))
	{
		if (bShowError==true)
		{
			LPCTSTR pszDescribe=TEXT("此游戏桌已经开始游戏了，暂时不能加入！");
			ShowMessageBox(pszDescribe,MB_ICONINFORMATION);
		}
		return false;
	}
	if ((bGameStart==false)&&(bLookon==true)&&(m_pMeUserItem->GetUserData()->dwMasterRight==0)) return false;

	//判断密码
	if ((pITableView->QueryPassFlag()==true)&&(m_pServerOption->m_bPassword==false))
	{
		if (bShowError==true)
		{
			LPCTSTR pszDescribe=TEXT("此游戏桌设置了桌子密码，请你设置桌子密码！");
			ShowMessageBox(pszDescribe,MB_ICONINFORMATION);
			;
			//CString s;
			//s.Format("%d",((CDlgControlBar*)GetParent())->m_rcViewItem.bottom);
			//MessageBox(s);
			//((CDlgControlBar*)GetParent())->
			//((CGameFrame*)theApp.GetMainWnd())->m_DlgControlBar.m_;
			
		}
		return false;
	}

	//旁观判断
	if (bLookon==true) return true;

	//规则判断
	tagUserData * pTableUserData=NULL;
	for (WORD i=0;i<m_TableFrame.GetTableCount();i++)
	{
		//获取用户
		pITableUserItem=pITableView->GetUserInfo(i);
		if ((pITableUserItem==NULL)||(pITableUserItem==m_pMeUserItem)) continue;
		pTableUserData=pITableUserItem->GetUserData();

		//网络延时
		if (m_pGameOption->m_bLimitDelay==true)
		{
			if (pTableUserData->wNetDelay>m_pGameOption->m_wNetDelay)
			{
				if (bShowError==true)
				{
					TCHAR szDescribe[128]=TEXT("");
					_snprintf(szDescribe,sizeof(szDescribe),TEXT("[ %s ] 的网络延时太高了，与你的设置不符！"),pTableUserData->szName);
					ShowMessageBox(szDescribe,MB_ICONINFORMATION);
				}
				return false;
			}
		}

		//厌恶玩家
		if (g_GlobalOption.m_bLimitDetest==true)
		{
			if (pTableUserData->cbCompanion==enCompanion_Detest)
			{
				if (bShowError==true)
				{
					TCHAR szDescribe[128]=TEXT("");
					_snprintf(szDescribe,sizeof(szDescribe),TEXT("你设置了不与不受欢迎的玩家游戏，此桌有你不欢迎的玩家 [ %s ] ！"),pTableUserData->szName);
					ShowMessageBox(szDescribe,MB_ICONINFORMATION);
				}
				return false;
			}
		}

		//胜率效验
		if (m_pGameOption->m_bLimitWin)
		{
			WORD wWinRate=0;
			LONG lAllCount=pITableUserItem->GetUserPlayCount();
			if (lAllCount>0) wWinRate=(WORD)(pTableUserData->lWinCount*10000/lAllCount);
			if (wWinRate<m_pGameOption->m_wWinRate)
			{
				if (bShowError==true)
				{
					TCHAR szDescribe[128]=TEXT("");
					_snprintf(szDescribe,sizeof(szDescribe),TEXT("[ %s ] 的胜率太低了，与你的设置不符！"),pTableUserData->szName);
					ShowMessageBox(szDescribe,MB_ICONINFORMATION);
				}
				return false;
			}
		}

		//逃率效验
		if (m_pGameOption->m_bLimitFlee)
		{
			WORD wFillRate=0;
			LONG lAllCount=pITableUserItem->GetUserPlayCount();
			if (lAllCount>0) wFillRate=(WORD)(pTableUserData->lFleeCount*10000/lAllCount);
			if ((wFillRate>0)&&(wFillRate>m_pGameOption->m_wFleeRate))
			{
				if (bShowError==true)
				{
					TCHAR szDescribe[128]=TEXT("");
					_snprintf(szDescribe,sizeof(szDescribe),TEXT("[ %s ] 的逃跑率太高了，与你的设置不符！"),pTableUserData->szName);
					ShowMessageBox(szDescribe,MB_ICONINFORMATION);
				}
				return false;
			}
		}

		//游戏币效验
		if (m_pGameOption->m_bLimitScore)
		{
			LONG lTableUserScore=pTableUserData->lScore;
			if (lTableUserScore>m_pGameOption->m_lMaxScore)
			{
				if (bShowError==true)
				{
					TCHAR szDescribe[128]=TEXT("");
					_snprintf(szDescribe,sizeof(szDescribe),TEXT("[ %s ] 的游戏币太高了，与你的设置不符！"),pTableUserData->szName);
					ShowMessageBox(szDescribe,MB_ICONINFORMATION);
				}
				return false;
			}
			if (lTableUserScore<m_pGameOption->m_lLessScore)
			{
				if (bShowError==true)
				{
					TCHAR szDescribe[128]=TEXT("");
					_snprintf(szDescribe,sizeof(szDescribe),TEXT("[ %s ] 的游戏币太低了，与你的设置不符！"),pTableUserData->szName);
					ShowMessageBox(szDescribe,MB_ICONINFORMATION);
				}
				return false;
			}
		}
	}

	return true;
}

//网络连接消息
bool __cdecl CRoomViewItem::OnSocketConnect(int iErrorCode, LPCTSTR pszErrorDesc, IClientSocket * pIClientSocke)
{
	//错误处理
	if (iErrorCode!=0)
	{
		g_GlobalAttemper.DestroyStatusWnd(this);
		ShowMessageBox(pszErrorDesc,MB_ICONINFORMATION);
		g_pControlBar->CloseRoomViewItem(this);
		return true;
	}

	//发送登录信息
	SendLogonPacket();
	m_ServiceStatus=ServiceStatus_EfficacyUser;

	return true;
}

//网络读取消息
bool __cdecl CRoomViewItem::OnSocketRead(CMD_Command Command, 
										 void * pBuffer, 
										 WORD wDataSize, 
										 IClientSocket * pIClientSocke)
{
	switch (Command.wMainCmdID)
	{
	case MDM_GR_LOGON:			//登录消息
		{
			return OnSocketMainLogon(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case MDM_GR_USER:			//用户消息
		{
			return OnSocketMainUser(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case MDM_GR_INFO:			//配置信息
		{
			return OnSocketMainInfo(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case MDM_GR_STATUS:			//状态信息
		{
			return OnSocketMainStatus(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case MDM_GR_SYSTEM:			//系统消息
		{
			return OnSocketMainSystem(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case MDM_GR_SERVER_INFO:	//房间信息
		{
			return OnSocketMainServerInfo(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case MDM_GF_GAME:			//游戏消息
	case MDM_GF_FRAME:			//框架消息
		{
			return OnSocketMainGameFrame(Command,pBuffer,wDataSize,pIClientSocke);
		}
	}

	return true;
}

//网络关闭消息
bool __cdecl CRoomViewItem::OnSocketClose(IClientSocket * pIClientSocke, bool bCloseByServer)
{
	//判断关闭
	bool bCloseRoomView=(m_ServiceStatus!=ServiceStatus_Serviceing);

	//关闭处理
	CloseGameClient();
	g_GlobalAttemper.DestroyStatusWnd(this);
	m_ServiceStatus=ServiceStatus_NetShutDown;
	if (bCloseByServer) 
	{
		m_MessageProxyHelper->InsertSystemString("由于网络问题，您已经与服务器断开连接，请重新连接",0);
		ShowMessageBox("由于网络问题，您已经与服务器断开连接，请重新连接",MB_ICONINFORMATION);
	}
	else ShowMessageBox("由于网络数据包处理失败，网络中断了",MB_ICONINFORMATION);

	//关闭房间
	if (bCloseRoomView==true) g_pControlBar->CloseRoomViewItem(this);

	::ShowWindow(AfxGetMainWnd()->GetSafeHwnd(),SW_RESTORE);
	return true;
}

//登录消息
bool CRoomViewItem::OnSocketMainLogon(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	ASSERT(Command.wMainCmdID==MDM_GR_LOGON);
	switch (Command.wSubCmdID)
	{
	case SUB_GR_LOGON_SUCCESS:		//登录成功
		{
			//设置变量
			m_ServiceStatus=ServiceStatus_RecvConfigInfo;

			return true;
		}
	case SUB_GR_LOGON_ERROR:		//登录失败
		{
			//效验参数
			CMD_GR_LogonError * pLogonError=(CMD_GR_LogonError *)pBuffer;
			ASSERT(wDataSize>=(sizeof(CMD_GR_LogonError)-sizeof(pLogonError->szErrorDescribe)));
			if (wDataSize<(sizeof(CMD_GR_LogonError)-sizeof(pLogonError->szErrorDescribe))) return false;

			//关闭连接
			g_GlobalAttemper.DestroyStatusWnd(this);
			pIClientSocke->CloseSocket(false);
			m_ServiceStatus=ServiceStatus_NetShutDown;

			//显示消息
			WORD wDescribeSize=wDataSize-(sizeof(CMD_GR_LogonError)-sizeof(pLogonError->szErrorDescribe));
			if (wDescribeSize>0)
			{
				pLogonError->szErrorDescribe[wDescribeSize-1]=0;
				ShowMessageBox(pLogonError->szErrorDescribe,MB_ICONINFORMATION);
			}

			//关闭房间
			g_pControlBar->CloseRoomViewItem(this);

			return true;
		}
	case SUB_GR_LOGON_FINISH:		//登录完成
		{
			//设置界面
			m_TableFrame.ShowUserInfo(true);
			g_GlobalAttemper.DestroyStatusWnd(this);
			g_pControlBar->ActiveRoomViewItem(this);

			//设置变量
			m_ServiceStatus=ServiceStatus_Serviceing;

			//发送规则
			SendUserRulePacket();

			//重入判断
			ASSERT(m_pMeUserItem!=NULL);
			tagUserData * pUserData=m_pMeUserItem->GetUserData();
			if (pUserData->wTableID!=INVALID_TABLE)
			{
				int iResult=StartGameClient();
			}

			return true;
		}
	}

	return true;
}

//用户消息
bool CRoomViewItem::OnSocketMainUser(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	switch (Command.wSubCmdID)
	{
	case SUB_GR_USER_COME:			//用户进入
		{
			return OnSocketSubUserCome(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case SUB_GR_USER_STATUS:		//用户状态
		{
			return OnSocketSubStatus(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case SUB_GR_USER_SCORE:			//用户分数
		{
			return OnSocketSubScore(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case SUB_GR_SIT_FAILED:			//坐下失败
		{
			return OnSocketSubSitFailed(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case SUB_GR_USER_CHAT:			//用户聊天
		{
			return OnSocketSubChat(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case SUB_GR_USER_WISPER:		//用户私语
		{
			return OnSocketSubWisper(Command,pBuffer,wDataSize,pIClientSocke);
		}
	case SUB_GR_USER_INVITE:		//邀请玩家
		{
			return OnSocketSubUserInvite(Command,pBuffer,wDataSize,pIClientSocke);
		}
	}

	return true;
}

//配置消息
bool CRoomViewItem::OnSocketMainInfo(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	ASSERT(Command.wMainCmdID==MDM_GR_INFO);
	switch (Command.wSubCmdID)
	{
	case SUB_GR_SERVER_INFO:	//房间信息
		{
			//效验数据
			ASSERT(wDataSize>=sizeof(CMD_GR_ServerInfo));
			if (wDataSize<sizeof(CMD_GR_ServerInfo)) return false;

			//消息处理
			CMD_GR_ServerInfo * pServerInfo=(CMD_GR_ServerInfo *)pBuffer;
			m_wGameGenre=pServerInfo->wGameGenre;

			//获取信息
			CListKind * pListKind=m_pListServer->GetListKind();
			tagGameKind * pGameKind=pListKind->GetItemInfo();
			IUnknownEx * pIUnknownEx=GET_MYSELF_INTERFACE(IUnknownEx);
			//m_UserListView.m_wKindID=pServerInfo->wKindID;
			//m_UserListView.m_wGameGenre=pServerInfo->wGameGenre;

			//创建桌子
			try
			{
				m_TableFrame.CreateTableFrame(this,100);
				m_TableFrame.InitTableFrame(pServerInfo->wTableCount,pServerInfo->wChairCount,pGameKind,pIUnknownEx);
			}
			catch (...)
			{
				//关闭网络
				m_ClientSocket->CloseSocket(false);
				g_GlobalAttemper.DestroyStatusWnd(this);

				//提示消息
				int nResult=ShowMessageBox(TEXT("游戏房间资源加载失败，重新下载安装可能会解决问题，是否立即下载？"),MB_ICONQUESTION|MB_YESNO);
				if (nResult==IDYES) 
				{
					CListKind * pListKind=m_pListServer->GetListKind();
					tagGameKind * pGameKind=pListKind->GetItemInfo();
					g_GlobalAttemper.DownLoadClient(pGameKind->szKindName,pGameKind->wKindID,true);
				}

				//关闭房间
				IRoomViewItem * pIRoomViewItem=GET_MYSELF_INTERFACE(IRoomViewItem);
				g_pControlBar->CloseRoomViewItem(pIRoomViewItem);

				return false;
			}

			return true;
		}
	case SUB_GR_COLUMN_INFO:	//列表解释
		{
			//变量定义
			CMD_GR_ColumnInfo * pColumnInfo=(CMD_GR_ColumnInfo *)pBuffer;
			WORD wHeadSize=sizeof(CMD_GR_ColumnInfo)-sizeof(pColumnInfo->ColumnItem);

			//效验参数
			ASSERT(wDataSize>=wHeadSize);
			ASSERT((wHeadSize+pColumnInfo->wColumnCount*sizeof(pColumnInfo->ColumnItem[0]))==wDataSize);
			if (wDataSize<wHeadSize) return false;
			if ((wHeadSize+pColumnInfo->wColumnCount*sizeof(pColumnInfo->ColumnItem[0]))!=wDataSize) return false;

			//设置列表
			CopyMemory(&m_ListColumnInfo,pColumnInfo,__min(wDataSize,sizeof(m_ListColumnInfo)));
			//m_UserListView.SetColumnDescribe(pColumnInfo->ColumnItem,pColumnInfo->wColumnCount);

			return true;
		}
	case SUB_GR_CONFIG_FINISH:	//配置完成
		{
			//显示房间
			ShowWindow(SW_SHOW);
			g_pControlBar->ActiveRoomViewItem(this);

			//设置变量
			m_ServiceStatus=ServiceStatus_RecvRoomInfo;

			return true;
		}
	}

	return true;
}

//状态消息
bool CRoomViewItem::OnSocketMainStatus(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	ASSERT(Command.wMainCmdID==MDM_GR_STATUS);
	switch (Command.wSubCmdID)
	{
	case SUB_GR_TABLE_INFO:		//桌子信息
		{
			//变量定义
			CMD_GR_TableInfo * pTableInfo=(CMD_GR_TableInfo *)pBuffer;
			const WORD wHeadSize=sizeof(CMD_GR_TableInfo)-sizeof(pTableInfo->TableStatus);

			//效验数据
			ASSERT(wDataSize>=wHeadSize);
			ASSERT((wHeadSize+pTableInfo->wTableCount*sizeof(pTableInfo->TableStatus[0]))==wDataSize);
			if (wDataSize<wHeadSize) return false;
			if ((wHeadSize+pTableInfo->wTableCount*sizeof(pTableInfo->TableStatus[0]))!=wDataSize) return false;

			//消息处理
			for (WORD i=0;i<pTableInfo->wTableCount;i++)
			{
				m_TableFrame.SetPassFlag(i,pTableInfo->TableStatus[i].bTableLock?true:false);
				m_TableFrame.SetPlayFlag(i,pTableInfo->TableStatus[i].bPlayStatus?true:false);
			}

			return true;
		}
	case SUB_GR_TABLE_STATUS:	//桌子状态
		{
			//效验数据
			ASSERT(wDataSize>=sizeof(CMD_GR_TableStatus));
			if (wDataSize<sizeof(CMD_GR_TableStatus)) return false;

			//消息处理
			CMD_GR_TableStatus * pTableStatus=(CMD_GR_TableStatus *)pBuffer;
			ASSERT(pTableStatus->wTableID<m_TableFrame.GetTableCount());
			if (pTableStatus->wTableID<m_TableFrame.GetTableCount())
			{
				//设置用户
				IUserItem * pIUserItem=NULL;
				tagUserData * pUserData=NULL;
				BYTE cbUserStatus=pTableStatus->bPlayStatus?US_PLAY:US_SIT;
				for (WORD i=0;i<m_TableFrame.GetChairCount();i++)
				{
					pIUserItem=m_TableFrame.GetUserInfo(pTableStatus->wTableID,i);
					if (pIUserItem!=NULL)
					{
						pUserData=pIUserItem->GetUserData();
						if (pUserData->cbUserStatus!=US_OFFLINE) 
						{
							pUserData->cbUserStatus=cbUserStatus;
							OnUserItemUpdate(pIUserItem);
						}
					}
				}

				//设置桌子
				m_TableFrame.SetPlayFlag(pTableStatus->wTableID,pTableStatus->bPlayStatus?true:false);

				//通知游戏
				tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
				if (pMeUserData->wTableID==pTableStatus->wTableID)
				{
					WORD wSubCmdID=pTableStatus->bPlayStatus?IPC_SUB_GAME_START:IPC_SUB_GAME_FINISH;
					SendProcessData(IPC_MAIN_USER,wSubCmdID,NULL,0);
				}
			}

			return true;
		}
	}

	return true;
}

//系统消息
bool CRoomViewItem::OnSocketMainSystem(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	ASSERT(Command.wMainCmdID==MDM_GR_SYSTEM);
	switch (Command.wSubCmdID)
	{
	case SUB_GR_MESSAGE:		//系统消息
		{
			//效验参数
			CMD_GR_Message * pMessage=(CMD_GR_Message *)pBuffer;
			ASSERT(wDataSize>(sizeof(CMD_GR_Message)-sizeof(pMessage->szContent)));
			if (wDataSize<=(sizeof(CMD_GR_Message)-sizeof(pMessage->szContent))) return false;

			//消息处理
			WORD wHeadSize=sizeof(CMD_GR_Message)-sizeof(pMessage->szContent);
			ASSERT(wDataSize==(wHeadSize+pMessage->wMessageLength*sizeof(TCHAR)));
			if (wDataSize!=(wHeadSize+pMessage->wMessageLength*sizeof(TCHAR))) return false;
			pMessage->szContent[pMessage->wMessageLength-1]=0;

			//关闭连接
			bool bIntermet=false;
			if (pMessage->wMessageType&SMT_INTERMIT_LINE) bIntermet=true;
			else if (pMessage->wMessageType&SMT_CLOSE_ROOM) bIntermet=true;
			if (bIntermet==true) 
			{
				g_GlobalAttemper.DestroyStatusWnd(this);
				m_ClientSocket->CloseSocket(false);
				CloseGameClient();
			}

			//显示消息
			if (pMessage->wMessageType&SMT_INFO) m_MessageProxyHelper->InsertSystemString(pMessage->szContent,MS_NORMAL);
			if (pMessage->wMessageType&SMT_EJECT) ShowMessageBox(pMessage->szContent,MB_ICONINFORMATION);

			//关闭房间
			if (pMessage->wMessageType&SMT_CLOSE_ROOM) 
			{
				IRoomViewItem * pIRoomViewItem=GET_MYSELF_INTERFACE(IRoomViewItem);
				g_pControlBar->CloseRoomViewItem(pIRoomViewItem);
			}

			return true;
		}
	}

	return true;
}

//房间消息
bool CRoomViewItem::OnSocketMainServerInfo(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	ASSERT(Command.wMainCmdID==MDM_GR_SERVER_INFO);
	switch (Command.wSubCmdID)
	{
	case SUB_GR_ONLINE_COUNT_INFO:		//在线信息
		{
			//效验数据
			ASSERT(wDataSize%sizeof(tagOnLineCountInfo)==0);
			if (wDataSize%sizeof(tagOnLineCountInfo)!=0) return false;

			//消息处理
			WORD wKindID=0;
			DWORD dwKindOnLineCount=0,dwAllOnLineCount=0L;
			WORD wInfoCount=wDataSize/sizeof(tagOnLineCountInfo);
			tagOnLineCountInfo * pOnLineCountInfo=(tagOnLineCountInfo *)pBuffer;
			for (int i=0;i<wInfoCount;i++)
			{
				wKindID=(pOnLineCountInfo+i)->wKindID;
				dwKindOnLineCount=(pOnLineCountInfo+i)->dwOnLineCount;
				dwAllOnLineCount+=dwKindOnLineCount;
				g_GlobalUnits.m_ServerListManager.UpdateGameKindOnLine(wKindID,dwKindOnLineCount);
			}

			//更新总数
			g_GlobalUnits.m_ServerListManager.UpdateGameOnLineCount(dwAllOnLineCount);

			return true;
		}
	}

	return true;
}

//游戏消息
bool CRoomViewItem::OnSocketMainGameFrame(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验数据
	ASSERT(wDataSize<=SOCKET_PACKAGE);
	if (wDataSize>SOCKET_PACKAGE) return false;

	//构造数据
	IPC_SocketPackage SocketPackage;
	memset(&SocketPackage,0,sizeof(SocketPackage));
	SocketPackage.Command=Command;
	if (wDataSize>0)
	{
		ASSERT(pBuffer!=NULL);
		CopyMemory(SocketPackage.cbBuffer,pBuffer,wDataSize);
	}

	//发送数据
	WORD wSendSize=sizeof(SocketPackage.Command)+wDataSize;
	SendProcessData(IPC_MAIN_SOCKET,IPC_SUB_SOCKET_RECV,&SocketPackage,wSendSize);

	return true;
}

//用户进入
bool CRoomViewItem::OnSocketSubUserCome(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_USER_COME);
	ASSERT(wDataSize>=sizeof(tagUserInfoHead));
	if (wDataSize<sizeof(tagUserInfoHead)) return false;

	//读取基本信息
	tagUserData UserData;
	memset(&UserData,0,sizeof(UserData));
	tagUserInfoHead * pUserInfoHead=(tagUserInfoHead *)pBuffer;
	UserData.wFaceID=pUserInfoHead->wFaceID;
	UserData.wTableID=pUserInfoHead->wTableID;
	UserData.wChairID=pUserInfoHead->wChairID;
	UserData.wNetDelay=pUserInfoHead->wNetDelay;
	UserData.cbGender=pUserInfoHead->cbGender;
	UserData.cbMember=pUserInfoHead->cbMember;
	UserData.cbUserStatus=pUserInfoHead->cbUserStatus;
	UserData.dwUserID=pUserInfoHead->dwUserID;
	UserData.dwGroupID=pUserInfoHead->dwGroupID;
	UserData.dwUserRight=pUserInfoHead->dwUserRight;
	UserData.dwMasterRight=pUserInfoHead->dwMasterRight;
	UserData.lGold=pUserInfoHead->UserScoreInfo.lGold;
	UserData.lScore=pUserInfoHead->UserScoreInfo.lScore;
	UserData.lWinCount=pUserInfoHead->UserScoreInfo.lWinCount;
	UserData.lLostCount=pUserInfoHead->UserScoreInfo.lLostCount;
	UserData.lDrawCount=pUserInfoHead->UserScoreInfo.lDrawCount;
	UserData.lFleeCount=pUserInfoHead->UserScoreInfo.lFleeCount;
	UserData.lExperience=pUserInfoHead->UserScoreInfo.lExperience;

	//读取扩展信息
	void * pDataBuffer=NULL;
	tagDataDescribe DataDescribe;
	CRecvPacketHelper RecvPacket(pUserInfoHead+1,wDataSize-sizeof(tagUserInfoHead));
	while (true)
	{
		pDataBuffer=RecvPacket.GetData(DataDescribe);
		if (DataDescribe.wDataDescribe==DTP_NULL) break;
		switch (DataDescribe.wDataDescribe)
		{
		case DTP_USER_ACCOUNTS:		//用户帐户
			{
				ASSERT(pDataBuffer!=NULL);
				ASSERT(DataDescribe.wDataSize<=sizeof(UserData.szName));
				if (DataDescribe.wDataSize<=sizeof(UserData.szName))
				{
					CopyMemory(&UserData.szName,pDataBuffer,DataDescribe.wDataSize);
					UserData.szName[CountArray(UserData.szName)-1]=0;
				}
				break;
			}
		case DTP_USER_GROUP_NAME:	//用户社团
			{
				ASSERT(pDataBuffer!=NULL);
				ASSERT(DataDescribe.wDataSize<=sizeof(UserData.szGroupName));
				if (DataDescribe.wDataSize<=sizeof(UserData.szGroupName))
				{
					CopyMemory(&UserData.szGroupName,pDataBuffer,DataDescribe.wDataSize);
					UserData.szGroupName[CountArray(UserData.szGroupName)-1]=0;
				}
				break;
			}
		}
	}

	//查找用户
	IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(UserData.dwUserID);
	if (pIUserItem==NULL) 
	{
		const tagCompanionItem * pCompanionItem=NULL;
		pCompanionItem=g_GlobalUnits.m_CompanionManager->SearchCompanionItem(UserData.dwUserID);
		if (pCompanionItem!=NULL) UserData.cbCompanion=pCompanionItem->Companion;
		pIUserItem=m_ClientUserManager.ActiveUserItem(UserData);
	}
	else OnUserItemUpdate(pIUserItem);

	//加入用户信息
	ASSERT(pIUserItem!=NULL);
	if (pIUserItem!=NULL)
	{
		//判断自己
		if (m_pMeUserItem==NULL) m_pMeUserItem=pIUserItem;

		//设置界面
		BYTE cbUserStatus=UserData.cbUserStatus;
		if ((cbUserStatus>=US_SIT)&&(cbUserStatus!=US_LOOKON))
			m_TableFrame.SetUserInfo(UserData.wTableID,UserData.wChairID,pIUserItem);

		//提示信息
		if (m_ServiceStatus==ServiceStatus_Serviceing)
		{
			TCHAR szMessage[256]=TEXT("");
			if (UserData.cbCompanion==enCompanion_Friend)
			{
				_snprintf(szMessage,sizeof(szMessage),TEXT("你的好友“%s”进来了"),UserData.szName);
				m_MessageProxyHelper->InsertSystemString(szMessage,0);
			}
			else
			{
				_snprintf(szMessage,sizeof(szMessage),TEXT("[ %s ] 进来了"),UserData.szName);
				m_MessageProxyHelper->InsertGeneralString(szMessage,0,0,true);
			}
		}
	}

	//更新标题
	UpdateTitleText();

	//更新人数
	DWORD dwOnLineCount=m_ClientUserManager.GetOnLineCount();
	g_GlobalUnits.m_ServerListManager.UpdateGameServerOnLine(m_pListServer,dwOnLineCount);
	SetAllocTableType();
	return true;
}

//用户状态
bool CRoomViewItem::OnSocketSubStatus(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_USER_STATUS);
	ASSERT(wDataSize>=sizeof(CMD_GR_UserStatus));
	if (wDataSize<sizeof(CMD_GR_UserStatus)) return false;

	//处理数据
	CMD_GR_UserStatus * pUserStatus=(CMD_GR_UserStatus *)pBuffer;
	IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(pUserStatus->dwUserID);
	ASSERT(pIUserItem!=NULL);
	if (pIUserItem==NULL) return true;

	//定义变量
	tagUserData * pUserData=pIUserItem->GetUserData();
	tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
	WORD wNowTableID=pUserStatus->wTableID,wLastTableID=pUserData->wTableID;
	WORD wNowChairID=pUserStatus->wChairID,wLastChairID=pUserData->wChairID;
	BYTE cbNowStatus=pUserStatus->cbUserStatus,cbLastStatus=pUserData->cbUserStatus;

	//清理旧状态
	if ((wLastTableID!=INVALID_TABLE)&&((wNowTableID!=wLastTableID)||(wNowChairID!=wLastChairID)))
	{
		ASSERT(wLastChairID!=INVALID_CHAIR);
		IUserItem * pITableUserItem=m_TableFrame.GetUserInfo(wLastTableID,wLastChairID);
		if (pITableUserItem==pIUserItem) m_TableFrame.SetUserInfo(wLastTableID,wLastChairID,NULL);
	}

	//用户离开
	if (cbNowStatus==US_NULL)
	{
		//通知游戏
		if ((pMeUserData->wTableID!=INVALID_TABLE)&&(pMeUserData->wTableID==wLastTableID))
		{
			IPC_UserStatus UserStatus;
			memset(&UserStatus,0,sizeof(UserStatus));
			UserStatus.dwUserID=pUserData->dwUserID;
			UserStatus.wNetDelay=pUserData->wNetDelay;
			UserStatus.cbUserStatus=pUserData->cbUserStatus;
			SendProcessData(IPC_MAIN_USER,IPC_SUB_USER_STATUS,&UserStatus,sizeof(UserStatus));
		}

		//删除用户
		m_ClientUserManager.DeleteUserItem(pIUserItem);

		//更新标题
		UpdateTitleText();

		//更新人数
		DWORD dwOnLineCount=m_ClientUserManager.GetOnLineCount();
		g_GlobalUnits.m_ServerListManager.UpdateGameServerOnLine(m_pListServer,dwOnLineCount);

		return true;
	}

	//更新状态
	tagUserStatus UserStatus;
	UserStatus.wTableID=wNowTableID;
	UserStatus.wChairID=wNowChairID;
	UserStatus.cbUserStatus=cbNowStatus;
	UserStatus.wNetDelay=pUserStatus->wNetDelay;
	m_ClientUserManager.UpdateUserItemStatus(pIUserItem,&UserStatus);

	//设置新状态
	if ((wNowTableID!=INVALID_TABLE)&&((wNowTableID!=wLastTableID)||(wNowChairID!=wLastChairID)))
	{
		//设置桌子
		if (cbNowStatus!=US_LOOKON)
		{
			ASSERT(wNowChairID!=INVALID_CHAIR);
			m_TableFrame.SetUserInfo(wNowTableID,wNowChairID,pIUserItem);
		}

		//发送用户
		if ((m_pMeUserItem!=pIUserItem)&&(pMeUserData->wTableID==wNowTableID))
		{
			CIPCSendCopyData SendCopyData(m_hWndChannel,m_hWnd);
			SendTableUser(pIUserItem,&SendCopyData);
		}
	}

	//更新界面
	if ((wNowTableID!=INVALID_TABLE)&&(cbNowStatus!=US_LOOKON)
		&&(wNowTableID==wLastTableID)&&(wNowChairID==wLastChairID))
	{
		ASSERT(wNowChairID!=INVALID_CHAIR);
		m_TableFrame.UpdateTableView(wNowTableID,false);
	}

	//判断发送
	bool bNotifyGame=false;
	if (pIUserItem==m_pMeUserItem) bNotifyGame=true;
	else if ((pMeUserData->wTableID!=INVALID_TABLE)&&(pMeUserData->wTableID==wNowTableID)) bNotifyGame=true;
	else if ((pMeUserData->wTableID!=INVALID_TABLE)&&(pMeUserData->wTableID==wLastTableID)) bNotifyGame=true;

	//发送状态
	if (bNotifyGame==true)
	{
		IPC_UserStatus UserStatus;
		memset(&UserStatus,0,sizeof(UserStatus));
		UserStatus.dwUserID=pUserData->dwUserID;
		UserStatus.wNetDelay=pUserData->wNetDelay;
		UserStatus.cbUserStatus=pUserData->cbUserStatus;
		SendProcessData(IPC_MAIN_USER,IPC_SUB_USER_STATUS,&UserStatus,sizeof(UserStatus));
	}

	//判断自己
	if (pIUserItem==m_pMeUserItem)
	{
		//设置变量
		if ((wNowTableID==m_wReqTableID)&&(wNowChairID==m_wReqChairID))
		{
			m_wReqTableID=INVALID_TABLE;
			m_wReqChairID=INVALID_CHAIR;
		}

		//启动游戏
		if ((wNowTableID!=INVALID_TABLE)&&((wNowTableID!=wLastTableID)||(wNowChairID!=wLastChairID)))
		{
			int iResult=StartGameClient();
		}
	}

	return true;
}

//用户分数
bool CRoomViewItem::OnSocketSubScore(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_USER_SCORE);
	ASSERT(wDataSize>=sizeof(CMD_GR_UserScore));
	if (wDataSize<sizeof(CMD_GR_UserScore)) return false;

	//处理数据
	CMD_GR_UserScore * pUserScore=(CMD_GR_UserScore *)pBuffer;
	IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(pUserScore->dwUserID);
	ASSERT(pIUserItem!=NULL);
	if (pIUserItem==NULL) return true;

	//更新分数
	m_ClientUserManager.UpdateUserItemScore(pIUserItem,&pUserScore->UserScore);

	//更新游戏
	tagUserData * pUserData=pIUserItem->GetUserData();
	tagUserData * pMeUserData=m_pMeUserItem->GetUserData();
	if ((pMeUserData->wTableID!=INVALID_TABLE)&&(pMeUserData->wTableID==pUserData->wTableID))
	{
		IPC_UserScore UserScore;
		memset(&UserScore,0,sizeof(UserScore));
		UserScore.dwUserID=pUserScore->dwUserID;
		UserScore.UserScore=pUserScore->UserScore;
		SendProcessData(IPC_MAIN_USER,IPC_SUB_USER_SCORE,&UserScore,sizeof(UserScore));
	}

	return true;
}

//坐下失败
bool CRoomViewItem::OnSocketSubSitFailed(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_SIT_FAILED);

	//消息处理
	CMD_GR_SitFailed * pSitFailed=(CMD_GR_SitFailed *)pBuffer;
	IUserItem * pISendUserItem=m_TableFrame.GetUserInfo(m_wReqTableID,m_wReqChairID);
	if (pISendUserItem==m_pMeUserItem) m_TableFrame.SetUserInfo(m_wReqTableID,m_wReqChairID,NULL);

	//设置变量
	m_wReqTableID=INVALID_TABLE;
	m_wReqChairID=INVALID_CHAIR;

	
	if(strncmp(szLessMoney,pSitFailed->szFailedDescribe,9)==0)
	{//游戏币不够
		
		int nResult=ShowMessageBox(pSitFailed->szFailedDescribe,MB_ICONQUESTION|MB_YESNO|MB_DEFBUTTON1);
		if (nResult==IDYES)
		{
			//打开充值网站
			g_GlobalUnits.GoWeb("/usercenter/bank.asp?action=cz",true);
		}
	}
	else
	{//显示消息
		
		ShowMessageBox(pSitFailed->szFailedDescribe,MB_ICONINFORMATION);
	}

	return true;
}

//用户聊天
bool CRoomViewItem::OnSocketSubChat(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_USER_CHAT);

	//效验参数
	CMD_GR_UserChat * pUserChat=(CMD_GR_UserChat *)pBuffer;
	ASSERT(wDataSize>=(sizeof(CMD_GR_UserChat)-sizeof(pUserChat->szChatMessage)));
	ASSERT(wDataSize==(sizeof(CMD_GR_UserChat)-sizeof(pUserChat->szChatMessage)+pUserChat->wChatLength));
	if (wDataSize<(sizeof(CMD_GR_UserChat)-sizeof(pUserChat->szChatMessage))) return false;
	if (wDataSize!=(sizeof(CMD_GR_UserChat)-sizeof(pUserChat->szChatMessage)+pUserChat->wChatLength)) return false;

	//寻找用户
	IUserItem * pISendUserItem=m_ClientUserManager.SearchUserByID(pUserChat->dwSendUserID);
	if (pISendUserItem==NULL) return true;
	tagUserData * pSendUserData=pISendUserItem->GetUserData();

	//消息过滤
	if ((pISendUserItem!=m_pMeUserItem)&&(pSendUserData->cbCompanion==enCompanion_Detest)) return true;
	
	//显示消息
	if (pUserChat->dwTargetUserID!=0L)
	{
		IUserItem * pIRecvUserItem=m_ClientUserManager.SearchUserByID(pUserChat->dwTargetUserID);
		if (pIRecvUserItem==NULL) return true;
		tagUserData * pRecvUserData=pIRecvUserItem->GetUserData();
		m_MessageProxyHelper->InsertUserChat(pSendUserData->szName,pRecvUserData->szName,pUserChat->szChatMessage,pUserChat->crFontColor,MS_NORMAL);
	}
	else m_MessageProxyHelper->InsertUserChat(pSendUserData->szName,pUserChat->szChatMessage,pUserChat->crFontColor,MS_NORMAL);

	return true;
}

//用户私语
bool CRoomViewItem::OnSocketSubWisper(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_USER_WISPER);

	//效验参数
	CMD_GR_Wisper * pWisper=(CMD_GR_Wisper *)pBuffer;
	ASSERT(wDataSize>=(sizeof(CMD_GR_Wisper)-sizeof(pWisper->szChatMessage)));
	ASSERT(wDataSize==(sizeof(CMD_GR_Wisper)-sizeof(pWisper->szChatMessage)+pWisper->wChatLength));
	if (wDataSize<(sizeof(CMD_GR_Wisper)-sizeof(pWisper->szChatMessage))) return false;
	if (wDataSize!=(sizeof(CMD_GR_Wisper)-sizeof(pWisper->szChatMessage)+pWisper->wChatLength)) return false;

	//寻找用户
	IUserItem * pISendUserItem=m_ClientUserManager.SearchUserByID(pWisper->dwSendUserID);
	IUserItem * pIRecvUserItem=m_ClientUserManager.SearchUserByID(pWisper->dwTargetUserID);
	if ((pISendUserItem==NULL)||(pIRecvUserItem==NULL)) return true;
	tagUserData * pUserDataSend=pISendUserItem->GetUserData();
	tagUserData * pUserDataRecv=pIRecvUserItem->GetUserData();

	//显示信息
	CShortMessage * pShortMessageWnd=NULL;
	if (pWisper->dwSendUserID==m_pMeUserItem->GetUserID())
	{
		//自己发送的消息
		pShortMessageWnd=ActiveShortWnd(pWisper->dwTargetUserID,pIRecvUserItem,true);
		if (pShortMessageWnd!=NULL) pShortMessageWnd->OnRecvMessage(pUserDataSend->szName,pWisper->szChatMessage,pWisper->crFontColor,true);
	}
	else	//其他游戏者发送信息
	{
		pShortMessageWnd=ActiveShortWnd(pWisper->dwSendUserID,pISendUserItem,true);
		if (pShortMessageWnd!=NULL)	pShortMessageWnd->OnRecvMessage(pUserDataSend->szName,pWisper->szChatMessage,pWisper->crFontColor,false);
	}

	return true;
}

//用户邀请
bool CRoomViewItem::OnSocketSubUserInvite(CMD_Command Command, void * pBuffer, WORD wDataSize, IClientSocket * pIClientSocke)
{
	//效验参数
	ASSERT(Command.wMainCmdID==MDM_GR_USER);
	ASSERT(Command.wSubCmdID==SUB_GR_USER_INVITE);

	//效验参数
	ASSERT(wDataSize==sizeof(CMD_GR_UserInvite));
	if (wDataSize!=sizeof(CMD_GR_UserInvite)) return false;

	//消息处理
	CMD_GR_UserInvite * pUserInvite=(CMD_GR_UserInvite *)pBuffer;
	ASSERT(pUserInvite->wTableID<m_TableFrame.GetTableCount());
	if (m_TableFrame.QueryPlayFlag(pUserInvite->wTableID)==true) return true;

	//寻找用户
	IUserItem * pIUserItem=m_ClientUserManager.SearchUserByID(pUserInvite->dwUserID);
	if (pIUserItem==NULL) return true;
	tagUserData * pUserData=pIUserItem->GetUserData();
	if (pUserData->wTableID==INVALID_TABLE) return true;

	//用户过虑
	if (pUserData->cbCompanion==enCompanion_Detest) return true;
	m_TableFrame.EnsureVisibleTable(pUserInvite->wTableID);

	//提示消息
	TCHAR szMessage[256]=TEXT("");
	_snprintf(szMessage,sizeof(szMessage),TEXT("[ %s ] 邀请你加入第 [ %ld ] 游戏桌进行游戏，是否同意？"),pUserData->szName,pUserInvite->wTableID+1);
	if (ShowMessageBox(szMessage,MB_ICONINFORMATION|MB_YESNO)==IDYES)
	{
		WORD wChairID=INVALID_CHAIR;
		WORD wNullCount=m_TableFrame.GetNullChairCount(pUserInvite->wTableID,wChairID);
		if (wNullCount==0) 
		{
			ShowMessageBox(TEXT("此游戏桌已经没有空位置了！"),MB_ICONINFORMATION);
			return true;
		}
		PerformSitDownAction(pUserInvite->wTableID,wChairID);
	}

	return true;
}

//IPC 内核命令
bool CRoomViewItem::OnIPCKernel(const IPC_Head * pHead, const void * pIPCBuffer, WORD wDataSize, HWND hWndSend)
{
	ASSERT(pHead->wMainCmdID==IPC_MIAN_IPC_KERNEL);
	switch (pHead->wSubCmdID)
	{
	case IPC_SUB_IPC_CLIENT_CONNECT:	//连接消息
		{
			//判断连接
			if (::IsChild(m_pShareMemory->hWndGameFrame,hWndSend)) return false;

			//设置变量
			ASSERT(m_hWndChannel==NULL);
			m_hWndChannel=hWndSend;

			//发送信息
			CIPCSendCopyData SendCopyData(m_hWndChannel,m_hWnd);
			IPCSendGameInfo(&SendCopyData);
			IPCSendTableUsers(&SendCopyData);
			SendCopyData.SendData(IPC_MAIN_CONCTROL,IPC_SUB_START_FINISH);

			return true;
		}
	case IPC_SUB_IPC_CLIENT_CLOSE:		//关闭消息
		{
			//判断连接
			if (hWndSend!=m_hWndChannel) return false;

			//发送消息
			tagUserData * pUserData=m_pMeUserItem->GetUserData();
			if (pUserData->wTableID!=WORD(INVALID_TABLE))
			{
				if (pUserData->cbUserStatus==US_PLAY) SendLeftGamePacket();
				SendStandUpPacket();
			}

			//设置变量
			m_hWndChannel=NULL;
			m_pShareMemory->hWndGameFrame=NULL;
			CloseHandle(g_GameProcessInfo.hThread);
			CloseHandle(g_GameProcessInfo.hProcess);
			memset(&g_GameProcessInfo,0,sizeof(g_GameProcessInfo));

			return true;
		}
	}

	return false;
}

//IPC 发包命令
bool CRoomViewItem::OnIPCSocket(const IPC_Head * pHead, const void * pIPCBuffer, WORD wDataSize, HWND hWndSend)
{
	ASSERT(pHead->wMainCmdID==IPC_MAIN_SOCKET);
	switch (pHead->wSubCmdID)
	{
	case IPC_SUB_SOCKET_SEND:	//发包消息
		{
			//效验数据
			ASSERT(wDataSize>=sizeof(CMD_Command));
			if (wDataSize<sizeof(CMD_Command)) 
			{
				return false;
			}

			//处理数据
			IPC_SocketPackage * pSocketPackage=(IPC_SocketPackage *)pIPCBuffer;
			CMD_Command *pCommand= &pSocketPackage->Command;
			WORD wSendSize=wDataSize-sizeof(CMD_Command);
			if (wSendSize==0) 
			{
				m_ClientSocket->SendData(pCommand->wMainCmdID,
									pCommand->wSubCmdID);
			}
			else 
			{
				m_ClientSocket->SendData(pCommand->wMainCmdID,
									pCommand->wSubCmdID,
									pSocketPackage->cbBuffer,
									wSendSize);
			}

			return true;
		}
	}

	return false;
}

//信道数据处理
bool __cdecl CRoomViewItem::OnChannelMessage(const IPC_Head * pHead, 
											 const void * pIPCBuffer, 
											 WORD wDataSize, 
											 HWND hWndSend)
{
	switch (pHead->wMainCmdID)
	{
	//内核消息
	case IPC_MIAN_IPC_KERNEL:		
		{
			return OnIPCKernel(pHead,pIPCBuffer,wDataSize,hWndSend);
		}

	//网络事件
	case IPC_MAIN_SOCKET:			
		{
			return OnIPCSocket(pHead,pIPCBuffer,wDataSize,hWndSend);
		}
	}
	return false;
}

//鼠标左键按下
void __cdecl CRoomViewItem::OnLButtonHitTable(WORD wTableID, WORD wChairID, bool bMirror)
{
	//判断状态
	if (m_ServiceStatus==ServiceStatus_NetShutDown)
	{
		if ((wTableID!=INVALID_TABLE)&&(wChairID!=INVALID_CHAIR))
		{
			LPCTSTR szMessage=TEXT("与游戏服务器的连接已经中断，是否退出当前游戏房间？");
			int iCode=ShowMessageBox(szMessage,MB_ICONINFORMATION|MB_YESNO);
			if (iCode==IDYES) g_pControlBar->CloseRoomViewItem(this);
		}
		return;
	}

	//动作过虑
	if (m_ServiceStatus!=ServiceStatus_Serviceing) return;
	if ((wTableID==m_wReqTableID)&&(wChairID==m_wReqChairID)) return;
	if ((wTableID==INVALID_TABLE)||(wChairID==INVALID_CHAIR)) return;

	//消息处理
	IUserItem * pTableUserItem=m_TableFrame.GetUserInfo(wTableID,wChairID);
	if (pTableUserItem!=NULL)
	{
		//旁观或者起来
		if (pTableUserItem==m_pMeUserItem)
		{
			if (m_pMeUserItem->GetUserData()->cbUserStatus>=US_PLAY) 
			{
				return;
			}
			if ((m_wReqTableID!=INVALID_TABLE)||(m_wReqChairID!=INVALID_CHAIR)) 
			{
				return;
			}
			m_wFindTableID=INVALID_TABLE;
			SendStandUpPacket();
		}
		else 
		{
			tagUserData * pUserData=m_pMeUserItem->GetUserData();
			if((pUserData->wTableID==wTableID)
				&& (pUserData->wChairID==wChairID)) 
			{
				return;
			}
			PerformLookonAction(wTableID,wChairID);
		}
	}
	else 
	{
		PerformSitDownAction(wTableID, wChairID);
	}

	//关闭镜像窗口
	//if (bMirror) 
	//{
	//	if (m_pDlgInvite->GetSafeHwnd()) m_pDlgInvite->DestroyWindow();
	//	if (m_pDlgFindTable->GetSafeHwnd()) m_pDlgFindTable->DestroyWindow();
	//}

	return;
}

//鼠标右键按下
void __cdecl CRoomViewItem::OnRButtonHitTable(WORD wTableID, 
											  WORD wChairID, 
											  bool bMirror)
{
	//获取桌子
	ITableView * pITableView=m_TableFrame.GetTableArrayPtr(wTableID);
	if (pITableView==NULL) 
	{
		return;
	}

	//获取用户
	IUserItem * pIUserItem=pITableView->GetUserInfo(wChairID);
	if (pIUserItem==NULL) 
	{
		return;
	}

	//显示菜单
	CPoint Point;
	GetCursorPos(&Point);
	ShowUserInfoMenu(pIUserItem,Point);

	return;
}

//鼠标双击
void __cdecl CRoomViewItem::OnDoubleHitTable(WORD wTableID, bool bMirror)
{
}

//用户进入;激活
void __cdecl CRoomViewItem::OnUserItemAcitve(IUserItem * pIUserItem)
{
	//m_UserListView.InsertUserItem(pIUserItem);
	tagUserData *User=pIUserItem->GetUserData();
	if(!User)return;

	//设置自已的名字颜色
	COLORREF TitleColor=0x00ffff;
	if(strcmp(g_GlobalUnits.GetGolbalUserData().szAccounts,User->szName)==0)
	{
		TitleColor = 0xddffff;
	}

	//插入按钮
	int nBtn=m_UserListView.AddButton(AfxGetInstanceHandle(),USERLIST_BTN,IMG_LISTCTRL_CMD_ID,
					User->szName,
					84 - strlen(User->szName)*4,7,TitleColor,0);
	if(!nBtn)return;

	tagImageListButton *Btn=m_UserListView.GetButtonInfo(nBtn);
	if(Btn)
	{
		UpdateUserMoney(nBtn,Btn->img,User);
	}
	return ;
}

void CRoomViewItem::UpdateUserMoney(int nBtn,CSkinImage &Img,tagUserData *User)
{
	CSkinImage tmp;
	tmp.SetLoadInfo(USERLIST_BTN,AfxGetInstanceHandle());
	CImageHandle ImgHandle(&Img);
	CImageHandle ImgHandlet(&tmp);

	HDC hdc=Img.GetDC();
	//擦掉Money
	tmp.Draw(hdc,CRect(0,0,195,35),CRect(0,0,195,35));

	//写新的Money
	char Money[32];
	sprintf(Money,"游戏币:%d",User->lScore);
	//m_UserListView.DrawText(nBtn,98 - strlen(Money)*4+1,25+1,Money,0xA04F19);
	//m_UserListView.DrawText(nBtn,98 - strlen(Money)*4,25,Money,0x00ffff);
	//m_UserListView.DrawText(nBtn,98 - strlen(Money)*4+1,25+1,Money,0xffffff);
	m_UserListView.DrawText(nBtn,98 - strlen(Money)*4,25,Money,0x000000);

	//画头像
	g_GlobalUnits.m_UserFaceRes->DrawSmallFace(CDC::FromHandle(hdc),3,3,User->wFaceID);
	Img.ReleaseDC();
	m_UserListView.UpdateButton();
}

//用户更新
void __cdecl CRoomViewItem::OnUserItemUpdate(IUserItem * pIUserItem)
{
	tagUserData *User=pIUserItem->GetUserData();
	if(!User)return;
	int nBtn = m_UserListView.GetButtonByTitle(User->szName);
	if(!nBtn)return;

	tagImageListButton *Btn=m_UserListView.GetButtonInfo(nBtn);
	if(Btn)
	{
		UpdateUserMoney(nBtn,Btn->img,User);
	}


	if (m_pFindUserDlg!=NULL) 
	{
		m_pFindUserDlg->UpdateUserItem(pIUserItem);
	}
	return ;
}

//用户删除
void __cdecl CRoomViewItem::OnUserItemDelete(IUserItem * pIUserItem)
{
	//获取用户
	ASSERT(pIUserItem!=NULL);
	DWORD dwUserID=pIUserItem->GetUserID();

	//聊天对象
	if (m_dwChatUserID==dwUserID)
	{
		SetChatObject(NULL);
		TCHAR szMessage[256]=TEXT("");
		_snprintf(szMessage,sizeof(szMessage),TEXT("[ %s ] 离开了，聊天对象设置为所有人"),pIUserItem->GetUserName());
		m_MessageProxyHelper->InsertSystemString(szMessage,0);
	}

	//聊天对象
	int nChatObjectCount=m_ChatObject.GetCount();
	for (int i=1;i<nChatObjectCount;i++)
	{
		if (m_ChatObject.GetItemData(i)==dwUserID)
		{
			if (m_ChatObject.GetCurSel()==i) 
			{
				m_dwChatUserID=0;
				m_szChatName[0]=0;
				m_ChatObject.SetCurSel(0);
			}
			m_ChatObject.DeleteString(i);
			break;
		}
	}

	//控制视图
	//m_UserListView.DeleteUserItem(pIUserItem);
	int nItem=m_UserListView.GetButtonByTitle(pIUserItem->GetUserName());
	if(nItem)m_UserListView.DeleteButton(nItem);
	m_UserListView.UpdateButton();

	if (m_pFindUserDlg!=NULL) m_pFindUserDlg->DeleteUserItem(pIUserItem);

	return;
}

//激活信息窗口
CShortMessage * CRoomViewItem::ActiveShortWnd(long int dwUserID, IUserItem * pUserItem, bool bCreate)
{
	//变量定义
	INT_PTR iCloseIndex=-1,iHideIndex=-1;
	
	//寻找敏合窗口
	for (INT_PTR i=0;i<m_ShortMessage.GetCount();i++)
	{
		CShortMessage * pShortMessageWnd=(CShortMessage *)m_ShortMessage.GetAt(i);
		ASSERT(pShortMessageWnd!=NULL);
		if (dwUserID==pShortMessageWnd->m_dwTargetUserID)
		{
			if (pShortMessageWnd->GetSafeHwnd()==NULL)
			{
				AfxSetResourceHandle(GetModuleHandle(NULL));
				pShortMessageWnd->Create(IDD_SHORT_MESSAGE,this);
			}
			pShortMessageWnd->ShowWindow(SW_SHOW);
			return pShortMessageWnd;
		}
		if (bCreate==true)
		{
			if ((iCloseIndex==-1)
				&&  (pShortMessageWnd->GetSafeHwnd()==NULL)) 
			{
				iCloseIndex=i;
			}
			if ((iHideIndex==-1)
				&& (pShortMessageWnd->GetSafeHwnd()!=NULL)
				&& (pShortMessageWnd->IsWindowVisible()==FALSE)) 
			{
				iHideIndex=i;
			}
		}
	}

	//使用关闭的窗口
	if ((bCreate==true)&&(iCloseIndex>=0))
	{
		CShortMessage *pShortMessageWnd = (CShortMessage *)m_ShortMessage.GetAt(iCloseIndex);
		ASSERT(pShortMessageWnd!=NULL);
		if (pShortMessageWnd->GetSafeHwnd()==NULL)
		{
			AfxSetResourceHandle(GetModuleHandle(NULL));
			pShortMessageWnd->Create(IDD_SHORT_MESSAGE,this);
		}
		pShortMessageWnd->SetTalkInfo(pUserItem,m_pListServer->GetItemInfo()->szServerName);
		pShortMessageWnd->ShowWindow(SW_SHOW);
		return pShortMessageWnd;
	}

	//使用隐藏窗口
	if ((bCreate==true)&&(iHideIndex>=0))
	{
		CShortMessage * pShortMessageWnd=(CShortMessage *)m_ShortMessage.GetAt(iHideIndex);
		ASSERT(pShortMessageWnd!=NULL);
		pShortMessageWnd->SetTalkInfo(pUserItem,m_pListServer->GetItemInfo()->szServerName);
		pShortMessageWnd->ShowWindow(SW_SHOW);
		return pShortMessageWnd;
	}

	//建立新窗口
	if ((bCreate==true)&&(m_ShortMessage.GetCount()<10))
	{
		try
		{
			CShortMessage * pShortMessageWnd=new CShortMessage(this);
			AfxSetResourceHandle(GetModuleHandle(NULL));
			pShortMessageWnd->SetTalkInfo(pUserItem,m_pListServer->GetItemInfo()->szServerName);
			pShortMessageWnd->Create(IDD_SHORT_MESSAGE,this);
			pShortMessageWnd->ShowWindow(SW_SHOW);
			m_ShortMessage.Add(pShortMessageWnd);
			
			return pShortMessageWnd;
		}
		catch (...) 
		{ 
			return NULL; 
		}
	}

	return NULL;
}


//激活用户个人SHOW窗口

CShow * CRoomViewItem::ActiveShowWnd(long int dwUserID, IUserItem * pUserItem, bool bCreate)
{
	//变量定义
	INT_PTR iCloseIndex=-1,iHideIndex=-1;
	
	//寻找敏合窗口
	for (INT_PTR i=0;i<m_ShowMessage.GetCount();i++)
	{
		CShow * pShowWnd=(CShow *)m_ShowMessage.GetAt(i);
		ASSERT(pShowWnd!=NULL);
		if (dwUserID==pShowWnd->m_dwTargetUserID)
		{
			if (pShowWnd->GetSafeHwnd()==NULL)
			{
				AfxSetResourceHandle(GetModuleHandle(NULL));
				pShowWnd->Create(IDD_SHOW,this);
			}
			pShowWnd->ShowWindow(SW_SHOW);
			return pShowWnd;
		}
		if (bCreate==true)
		{
			if ((iCloseIndex==-1)
				&&  (pShowWnd->GetSafeHwnd()==NULL)) 
			{
				iCloseIndex=i;
			}
			if ((iHideIndex==-1)
				&& (pShowWnd->GetSafeHwnd()!=NULL)
				&& (pShowWnd->IsWindowVisible()==FALSE)) 
			{
				iHideIndex=i;
			}
		}
	}

	//使用关闭的窗口
	if ((bCreate==true)&&(iCloseIndex>=0))
	{
		CShow *pShowWnd = (CShow *)m_ShowMessage.GetAt(iCloseIndex);
		ASSERT(pShowWnd!=NULL);
		if (pShowWnd->GetSafeHwnd()==NULL)
		{
			AfxSetResourceHandle(GetModuleHandle(NULL));
			pShowWnd->Create(IDD_SHOW,this);
		}
		pShowWnd->ShowWindow(SW_SHOW);
		return pShowWnd;
	}

	//使用隐藏窗口
	if ((bCreate==true)&&(iHideIndex>=0))
	{
		CShow * pShowWnd=(CShow *)m_ShowMessage.GetAt(iHideIndex);
		ASSERT(pShowWnd!=NULL);
	
		pShowWnd->ShowWindow(SW_SHOW);
		return pShowWnd;
	}

	//建立新窗口
	if ((bCreate==true)&&(m_ShowMessage.GetCount()<10))
	{
		try
		{
			CShow * pShowWnd=new CShow(this);
			AfxSetResourceHandle(GetModuleHandle(NULL));
			
			pShowWnd->Create(IDD_SHOW,this);
			pShowWnd->ShowWindow(SW_SHOW);
			m_ShortMessage.Add(pShowWnd);
			
			return pShowWnd;
		}
		catch (...) 
		{ 
			return NULL;
		}
	}

	return NULL;
}




//聊天对象
bool CRoomViewItem::SetChatObject(IUserItem * pIUserItem)
{
	if (pIUserItem!=NULL)
	{
		//设置变量
		tagUserData * pUserData=pIUserItem->GetUserData();
		m_dwChatUserID=pUserData->dwUserID;
		lstrcpyn(m_szChatName,pUserData->szName,CountArray(m_szChatName));

		//寻找玩家
		int nItemCount=m_ChatObject.GetCount();
		for (int i=0;i<nItemCount;i++)
		{
			if (m_ChatObject.GetItemData(i)==m_dwChatUserID)
			{
				m_ChatObject.SetCurSel(i);
				return true;
			}
		}
		
		//插入对象
		int iItem=m_ChatObject.AddString(m_szChatName);
		m_ChatObject.SetItemData(iItem,m_dwChatUserID);
		m_ChatObject.SetCurSel(iItem);
	}
	else
	{
		//设置变量
		m_dwChatUserID=0L;
		m_szChatName[0]=0;

		//设置界面
		m_ChatObject.SetCurSel(0);
	}

	return true;
}

afx_msg void CRoomViewItem::OnBnUserList_Clicked()
{
ULONG nButton;
tagImageListButton *BtnInfo;

	nButton=m_UserListView.GetLastButton();
	if(nButton)
	{
		//BtnInfo=m_UserListView.GetButtonInfo(nButton);
		//if(!BtnInfo)return;
		//tagGlobalUserData UserData=g_GlobalUnits.GetGolbalUserData();
		//CString ShowUrl;
		//ShowUrl.Format(UrlQQShow,BtnInfo->Title);
		//g_GlobalUnits.AddSessionUrl(ShowUrl,ShowUrl);
		//m_pHtmlBrower->Navigate(ShowUrl);
		//return;
		BtnInfo=m_UserListView.GetButtonInfo(nButton);
		if(!BtnInfo)return;
		//获取用户
		IUserItem * pIUserItem=m_ClientUserManager.SearchUserByAccounts(BtnInfo->Title);
		if (pIUserItem==NULL) 
		{
			return;
		}

		//显示菜单
		CPoint Point;
		GetCursorPos(&Point);
		ShowUserInfoMenu(pIUserItem,Point);
		return;
	}
	nButton=m_UserListView.GetLastButtonRT();
	if(nButton)
	{
		BtnInfo=m_UserListView.GetButtonInfo(nButton);
		if(!BtnInfo)return;
		//获取用户
		IUserItem * pIUserItem=m_ClientUserManager.SearchUserByAccounts(BtnInfo->Title);
		if (pIUserItem==NULL) 
		{
			return;
		}

		//显示菜单
		CPoint Point;
		GetCursorPos(&Point);
		ShowUserInfoMenu(pIUserItem,Point);
		return;
	}
}

//////////////////////////////////////////////////////////////////////////


